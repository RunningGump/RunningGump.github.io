<!DOCTYPE html>












  


<html class="theme-next muse use-motion" lang="zh-CN">
<head>
  <meta charset="UTF-8"/>
<meta http-equiv="X-UA-Compatible" content="IE=edge" />
<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=2"/>
<meta name="theme-color" content="#222">












<meta http-equiv="Cache-Control" content="no-transform" />
<meta http-equiv="Cache-Control" content="no-siteapp" />






















<link href="/lib/font-awesome/css/font-awesome.min.css?v=4.6.2" rel="stylesheet" type="text/css" />

<link href="/css/main.css?v=6.3.0" rel="stylesheet" type="text/css" />


  <link rel="apple-touch-icon" sizes="180x180" href="/images/apple-touch-icon-next.png?v=6.3.0">


  <link rel="icon" type="image/png" sizes="32x32" href="/images/favicon-32x32.ico?v=6.3.0">


  <link rel="icon" type="image/png" sizes="16x16" href="/images/favicon-16x16.ico?v=6.3.0">


  <link rel="mask-icon" href="/images/logo.svg?v=6.3.0" color="#222">









<script type="text/javascript" id="hexo.configurations">
  var NexT = window.NexT || {};
  var CONFIG = {
    root: '/',
    scheme: 'Muse',
    version: '6.3.0',
    sidebar: {"position":"left","display":"post","offset":12,"b2t":false,"scrollpercent":false,"onmobile":false},
    fancybox: false,
    fastclick: false,
    lazyload: false,
    tabs: true,
    motion: {"enable":true,"async":false,"transition":{"post_block":"fadeIn","post_header":"slideDownIn","post_body":"slideDownIn","coll_header":"slideLeftIn","sidebar":"slideUpIn"}},
    algolia: {
      applicationID: '',
      apiKey: '',
      indexName: '',
      hits: {"per_page":10},
      labels: {"input_placeholder":"Search for Posts","hits_empty":"We didn't find any results for the search: ${query}","hits_stats":"${hits} results found in ${time} ms"}
    }
  };
</script>


  




  <meta name="description" content="设计思路前言国家企业信用信息公示系统中的验证码是按语序点击汉字，如下图所示：  即，如果依次点击：‘无’，‘意’，‘中’，‘发’，‘现’，就会通过验证。 本项目的破解思路主要分为以下步骤：  使用目标探测网络YOLOV2进行汉字定位 设计算法进行汉字切割 使用darknet的分类器进行汉字识别 设计算法进行汉字纠错与语序识别  Github仓库直通车 汉字定位与汉字识别本项目的汉字定位和汉字识别部">
<meta name="keywords" content="yolo,点击验证码,国家企业信用信息公示系统">
<meta property="og:type" content="article">
<meta property="og:title" content="破解含语序问题的点击验证码">
<meta property="og:url" content="http://yoursite.com/2018/11/19/破解含语序问题的点击验证码/index.html">
<meta property="og:site_name" content="初心">
<meta property="og:description" content="设计思路前言国家企业信用信息公示系统中的验证码是按语序点击汉字，如下图所示：  即，如果依次点击：‘无’，‘意’，‘中’，‘发’，‘现’，就会通过验证。 本项目的破解思路主要分为以下步骤：  使用目标探测网络YOLOV2进行汉字定位 设计算法进行汉字切割 使用darknet的分类器进行汉字识别 设计算法进行汉字纠错与语序识别  Github仓库直通车 汉字定位与汉字识别本项目的汉字定位和汉字识别部">
<meta property="og:locale" content="zh-CN">
<meta property="og:image" content="http://yoursite.com/2018/11/19/破解含语序问题的点击验证码/gsxt.png">
<meta property="og:image" content="http://yoursite.com/2018/11/19/破解含语序问题的点击验证码/crack.jpg">
<meta property="og:image" content="http://yoursite.com/2018/11/19/破解含语序问题的点击验证码/不忘初心.png">
<meta property="og:updated_time" content="2018-12-04T17:45:36.382Z">
<meta name="twitter:card" content="summary">
<meta name="twitter:title" content="破解含语序问题的点击验证码">
<meta name="twitter:description" content="设计思路前言国家企业信用信息公示系统中的验证码是按语序点击汉字，如下图所示：  即，如果依次点击：‘无’，‘意’，‘中’，‘发’，‘现’，就会通过验证。 本项目的破解思路主要分为以下步骤：  使用目标探测网络YOLOV2进行汉字定位 设计算法进行汉字切割 使用darknet的分类器进行汉字识别 设计算法进行汉字纠错与语序识别  Github仓库直通车 汉字定位与汉字识别本项目的汉字定位和汉字识别部">
<meta name="twitter:image" content="http://yoursite.com/2018/11/19/破解含语序问题的点击验证码/gsxt.png">






  <link rel="canonical" href="http://yoursite.com/2018/11/19/破解含语序问题的点击验证码/"/>



<script type="text/javascript" id="page.configurations">
  CONFIG.page = {
    sidebar: "",
  };
</script>

  <title>破解含语序问题的点击验证码 | 初心</title>
  









  <noscript>
  <style type="text/css">
    .use-motion .motion-element,
    .use-motion .brand,
    .use-motion .menu-item,
    .sidebar-inner,
    .use-motion .post-block,
    .use-motion .pagination,
    .use-motion .comments,
    .use-motion .post-header,
    .use-motion .post-body,
    .use-motion .collection-title { opacity: initial; }

    .use-motion .logo,
    .use-motion .site-title,
    .use-motion .site-subtitle {
      opacity: initial;
      top: initial;
    }

    .use-motion {
      .logo-line-before i { left: initial; }
      .logo-line-after i { right: initial; }
    }
  </style>
</noscript>

</head>

<body itemscope itemtype="http://schema.org/WebPage" lang="zh-CN">

  
  
    
  

  <div class="container sidebar-position-left page-post-detail">
    <div class="headband"></div>
	<!--Github-start-->
	<a href="https://github.com/runninggump" class="github-corner" aria-label="View source on Github"><svg width="80" height="80" viewBox="0 0 250 250" style="fill:#151513; color:#fff; position: absolute; top: 0; border: 0; right: 0;" aria-hidden="true"><path d="M0,0 L115,115 L130,115 L142,142 L250,250 L250,0 Z"></path><path d="M128.3,109.0 C113.8,99.7 119.0,89.6 119.0,89.6 C122.0,82.7 120.5,78.6 120.5,78.6 C119.2,72.0 123.4,76.3 123.4,76.3 C127.3,80.9 125.5,87.3 125.5,87.3 C122.9,97.6 130.6,101.9 134.4,103.2" fill="currentColor" style="transform-origin: 130px 106px;" class="octo-arm"></path><path d="M115.0,115.0 C114.9,115.1 118.7,116.5 119.8,115.4 L133.7,101.6 C136.9,99.2 139.9,98.4 142.2,98.6 C133.8,88.0 127.5,74.4 143.8,58.0 C148.5,53.4 154.0,51.2 159.7,51.0 C160.3,49.4 163.2,43.6 171.4,40.1 C171.4,40.1 176.1,42.5 178.8,56.2 C183.1,58.6 187.2,61.8 190.9,65.4 C194.5,69.0 197.7,73.2 200.1,77.6 C213.8,80.2 216.3,84.9 216.3,84.9 C212.7,93.1 206.9,96.0 205.4,96.6 C205.1,102.4 203.0,107.8 198.3,112.5 C181.9,128.9 168.3,122.5 157.7,114.1 C157.9,116.9 156.7,120.9 152.7,124.9 L141.0,136.5 C139.8,137.7 141.6,141.9 141.8,141.8 Z" fill="currentColor" class="octo-body"></path></svg></a><style>.github-corner:hover .octo-arm{animation:octocat-wave 560ms ease-in-out}@keyframes octocat-wave{0%,100%{transform:rotate(0)}20%,60%{transform:rotate(-25deg)}40%,80%{transform:rotate(10deg)}}@media (max-width:500px){.github-corner:hover .octo-arm{animation:none}.github-corner .octo-arm{animation:octocat-wave 560ms ease-in-out}}</style>
	<!--Github-end-->
    <header id="header" class="header" itemscope itemtype="http://schema.org/WPHeader">
      <div class="header-inner"><div class="site-brand-wrapper">
  <div class="site-meta ">
    

    <div class="custom-logo-site-title">
      <a href="/" class="brand" rel="start">
        <span class="logo-line-before"><i></i></span>
        <span class="site-title">初心</span>
        <span class="logo-line-after"><i></i></span>
      </a>
    </div>
    
  </div>

  <div class="site-nav-toggle">
    <button aria-label="切换导航栏">
      <span class="btn-bar"></span>
      <span class="btn-bar"></span>
      <span class="btn-bar"></span>
    </button>
  </div>
</div>



<nav class="site-nav">
  
    <ul id="menu" class="menu">
      
        
        
        
          
          <li class="menu-item menu-item-home">
    <a href="/" rel="section">
      <i class="menu-item-icon fa fa-fw fa-home"></i> <br />首页</a>
  </li>
        
        
        
          
          <li class="menu-item menu-item-about">
    <a href="/about/" rel="section">
      <i class="menu-item-icon fa fa-fw fa-user"></i> <br />关于</a>
  </li>
        
        
        
          
          <li class="menu-item menu-item-tags">
    <a href="/tags/" rel="section">
      <i class="menu-item-icon fa fa-fw fa-tags"></i> <br />标签</a>
  </li>
        
        
        
          
          <li class="menu-item menu-item-categories">
    <a href="/categories/" rel="section">
      <i class="menu-item-icon fa fa-fw fa-th"></i> <br />分类</a>
  </li>
        
        
        
          
          <li class="menu-item menu-item-archives">
    <a href="/archives/" rel="section">
      <i class="menu-item-icon fa fa-fw fa-archive"></i> <br />归档</a>
  </li>

      
      
        <li class="menu-item menu-item-search">
          
            <a href="javascript:;" class="popup-trigger">
          
            
              <i class="menu-item-icon fa fa-search fa-fw"></i> <br />搜索</a>
        </li>
      
    </ul>
  

  
    

  

  
    <div class="site-search">
      
  <div class="popup search-popup local-search-popup">
  <div class="local-search-header clearfix">
    <span class="search-icon">
      <i class="fa fa-search"></i>
    </span>
    <span class="popup-btn-close">
      <i class="fa fa-times-circle"></i>
    </span>
    <div class="local-search-input-wrapper">
      <input autocomplete="off"
             placeholder="搜索..." spellcheck="false"
             type="text" id="local-search-input">
    </div>
  </div>
  <div id="local-search-result"></div>
</div>



    </div>
  
</nav>



  



</div>
    </header>

    


    <main id="main" class="main">
      <div class="main-inner">
        <div class="content-wrap">
          
          <div id="content" class="content">
            

  <div id="posts" class="posts-expand">
    

  

  
  
  

  

  <article class="post post-type-normal" itemscope itemtype="http://schema.org/Article">
  
  
  
  <div class="post-block">
    <link itemprop="mainEntityOfPage" href="http://yoursite.com/2018/11/19/破解含语序问题的点击验证码/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="耿泽浩">
      <meta itemprop="description" content="Stay hungry, Stay foolish.">
      <meta itemprop="image" content="/images/header.jpeg">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="初心">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">破解含语序问题的点击验证码
              
            
          </h1>
        

        <div class="post-meta">
          <span class="post-time">

            
            
            

            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">发表于</span>
              

              
                
              

              <time title="创建时间：2018-11-19 11:40:52" itemprop="dateCreated datePublished" datetime="2018-11-19T11:40:52+08:00">2018-11-19</time>
            

            
              

              
                
                <span class="post-meta-divider">|</span>
                

                <span class="post-meta-item-icon">
                  <i class="fa fa-calendar-check-o"></i>
                </span>
                
                  <span class="post-meta-item-text">更新于</span>
                
                <time title="修改时间：2018-12-05 01:45:36" itemprop="dateModified" datetime="2018-12-05T01:45:36+08:00">2018-12-05</time>
              
            
          </span>

          
            <span class="post-category" >
            
              <span class="post-meta-divider">|</span>
            
              <span class="post-meta-item-icon">
                <i class="fa fa-folder-o"></i>
              </span>
              
                <span class="post-meta-item-text">分类于</span>
              
              
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing"><a href="/categories/深度学习/" itemprop="url" rel="index"><span itemprop="name">深度学习</span></a></span>

                
                
              
            </span>
          

          
            
              <span class="post-comments-count">
                <span class="post-meta-divider">|</span>
                <span class="post-meta-item-icon">
                  <i class="fa fa-comment-o"></i>
                </span>
                <a href="/2018/11/19/破解含语序问题的点击验证码/#comments" itemprop="discussionUrl">
                  <span class="post-meta-item-text">评论数：</span> <span class="post-comments-count valine-comment-count" data-xid="/2018/11/19/破解含语序问题的点击验证码/" itemprop="commentCount"></span>
                </a>
              </span>
            
          

          
          
             <span id="/2018/11/19/破解含语序问题的点击验证码/" class="leancloud_visitors" data-flag-title="破解含语序问题的点击验证码">
               <span class="post-meta-divider">|</span>
               <span class="post-meta-item-icon">
                 <i class="fa fa-eye"></i>
               </span>
               
                 <span class="post-meta-item-text">阅读次数：</span>
               
                 <span class="leancloud-visitors-count"></span>
             </span>
          

          

          

          

        </div>
      </header>
    

    
    
    
    <div class="post-body" itemprop="articleBody">

      
      

      
        <h1 id="设计思路"><a href="#设计思路" class="headerlink" title="设计思路"></a>设计思路</h1><h2 id="前言"><a href="#前言" class="headerlink" title="前言"></a>前言</h2><p><a href="http://www.gsxt.gov.cn/index.html" target="_blank" rel="noopener">国家企业信用信息公示系统</a>中的验证码是按语序点击汉字，如下图所示：</p>
<p><img src="/2018/11/19/破解含语序问题的点击验证码/gsxt.png" alt="验证码"></p>
<p>即，如果依次点击：‘无’，‘意’，‘中’，‘发’，‘现’，就会通过验证。</p>
<p>本项目的<strong>破解思路</strong>主要分为以下步骤：</p>
<ol>
<li>使用目标探测网络YOLOV2进行<strong>汉字定位</strong></li>
<li>设计算法进行<strong>汉字切割</strong></li>
<li>使用darknet的分类器进行<strong>汉字识别</strong></li>
<li>设计算法进行<strong>汉字纠错与语序识别</strong></li>
</ol>
<p><a href="https://github.com/RunningGump/gsxt_captcha" target="_blank" rel="noopener">Github仓库直通车</a></p>
<h2 id="汉字定位与汉字识别"><a href="#汉字定位与汉字识别" class="headerlink" title="汉字定位与汉字识别"></a>汉字定位与汉字识别</h2><p>本项目的汉字定位和汉字识别部分都是基于<code>darknet</code>框架进行训练的。本项目对它们使用的训练网络并没有太高要求，只需懂得如何使用darknet就可以了，关于如何使用darknet框架训练汉字定位模型和汉字识别模型可查阅<strong>模型训练文档</strong>以及<a href="https://pjreddie.com/darknet/" target="_blank" rel="noopener">官方文档</a>的YOLO和Train a Classifier部分。那么，下面主要对汉字切割和语序识别进行讲解，最后再对整个破解程序进行讲解。</p>
<h2 id="汉字切割算法"><a href="#汉字切割算法" class="headerlink" title="汉字切割算法"></a>汉字切割算法</h2><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">seg_one_img</span><span class="params">(img_path, rets)</span>:</span></span><br><span class="line">    img = cv2.imread(img_path)</span><br><span class="line">    hanzi_list = [] <span class="comment"># 用于记录每个汉字对应的坐标：key为切割后汉字图片路径，value为中心点坐标</span></span><br><span class="line">    <span class="comment"># 对定位框进行遍历</span></span><br><span class="line">    <span class="keyword">for</span> ret <span class="keyword">in</span> rets:</span><br><span class="line">        per_dict = &#123;&#125;</span><br><span class="line">        <span class="keyword">if</span> ret[<span class="number">1</span>] &gt; <span class="number">0.5</span>: <span class="comment"># 只取置信度大于0.5的定位框</span></span><br><span class="line">            coordinate = ret[<span class="number">2</span>] <span class="comment"># ret[2]为定位器返回的归一化坐标（x,y,w,h）</span></span><br><span class="line">            center = (int(coordinate[<span class="number">0</span>]*<span class="number">344</span>), int(coordinate[<span class="number">1</span>]*<span class="number">384</span>)) <span class="comment">#汉字定位框中心点坐标</span></span><br><span class="line">            origin = (coordinate[<span class="number">0</span>] - coordinate[<span class="number">2</span>]/<span class="number">2</span>, </span><br><span class="line">                    coordinate[<span class="number">1</span>] - coordinate[<span class="number">3</span>]/<span class="number">2</span>) <span class="comment"># 汉字定位框左上角坐标（归一化）</span></span><br><span class="line">            <span class="comment"># 将定位框向四周均匀扩大2个像素，尽量将整个汉字切割下来。</span></span><br><span class="line">            x = int(origin[<span class="number">0</span>]*<span class="number">344</span> - <span class="number">2</span>)</span><br><span class="line">            x_plus_w =int((origin[<span class="number">0</span>] + coordinate[<span class="number">2</span>])*<span class="number">344</span> + <span class="number">4</span>)</span><br><span class="line">            y = int(origin[<span class="number">1</span>]*<span class="number">384</span> - <span class="number">2</span>)</span><br><span class="line">            y_plus_h = int((origin[<span class="number">1</span>] + coordinate[<span class="number">3</span>])*<span class="number">384</span> + <span class="number">4</span>)</span><br><span class="line">            <span class="comment"># 扩大后的定位框可能会出现越界的可能，如一个紧挨着图片边缘的汉字，fix函数调整越界的定位框</span></span><br><span class="line">            x, y, x_plus_w, y_plus_h = fix(x,y,x_plus_w,y_plus_h)</span><br><span class="line">            <span class="comment"># 下面对图片进行切割，并保存</span></span><br><span class="line">            <span class="keyword">try</span>:</span><br><span class="line">                hanzi_img = img[y:y_plus_h, x:x_plus_w] <span class="comment"># 切割</span></span><br><span class="line">                normal_img = cv2.resize(hanzi_img, (<span class="number">65</span>,<span class="number">65</span>), </span><br><span class="line">                        interpolation=cv2.INTER_CUBIC) <span class="comment"># 将截取的图片规范化为65*65*3</span></span><br><span class="line">                path = <span class="string">'hanzi_img/&#123;&#125;_label.jpg.format(timestamp())</span></span><br><span class="line"><span class="string">                cv2.imwrite(path, normal_img)</span></span><br><span class="line"><span class="string">                per_dict[path] = center</span></span><br><span class="line"><span class="string">                hanzi_list.append(per_dict) </span></span><br><span class="line"><span class="string">            except:</span></span><br><span class="line"><span class="string">                print('</span><span class="comment">#'*20)</span></span><br><span class="line">                print(<span class="string">'存在不规则的图片'</span>)</span><br><span class="line">    <span class="keyword">return</span> hanzi_list</span><br><span class="line"></span><br><span class="line"><span class="comment"># 修正定位框的坐标，如果扩大后的定位框越界则将其设置为边界坐标</span></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">fix</span><span class="params">(x, y, x_plus_w, y_plus_h )</span>:</span></span><br><span class="line">    x = <span class="number">0</span> <span class="keyword">if</span> x &lt; <span class="number">0</span> <span class="keyword">else</span> x</span><br><span class="line">    y = <span class="number">0</span> <span class="keyword">if</span> y &lt; <span class="number">0</span> <span class="keyword">else</span> y</span><br><span class="line">    x_plus_w = <span class="number">384</span> <span class="keyword">if</span> x_plus_w &gt; <span class="number">384</span> <span class="keyword">else</span> x_plus_w</span><br><span class="line">    y_plus_h = <span class="number">344</span> <span class="keyword">if</span> y_plus_h &gt; <span class="number">344</span> <span class="keyword">else</span> y_plus_h</span><br><span class="line">    <span class="keyword">return</span> x, y, x_plus_w, y_plus_h</span><br></pre></td></tr></table></figure>
<p><code>seg_one_img</code>函数是对一张验证码图片进行汉字切割，切割后的汉字图片保存在当前路径下的<code>hanzi_img</code>文件夹中，并且返回由字典（key为汉字图片路径，value为坐标）组成的列表。需要注意的是，定位接口返回的定位框信息均是归一化信息，需要转换成实际的坐标信息，验证码图片大小信息为：344 × 384 × 3。如（0.25，,75）&gt;&gt; (0.25×344,0.75×384)</p>
<p><strong>算法大体思路：</strong></p>
<p>切割一张图片（图片路径，定位接口返回的定位框信息）：</p>
<pre><code>遍历定位框信息，对置信度大于0.5的定位框进行如下操作：

    计算汉字定位框中心坐标和左上角坐标；

    将汉字定位框向四周均匀扩大两个像素；

    对越界的坐标进行修正；

    对汉字进行切割；
</code></pre><p>定位框向四周扩大两个像素的目的：尽量将整个汉字切割下来。因为经过测试，有些定位框定位正确但是IOU不是很高，即汉字的某一小部分可能在定位框外部。扩大定位框可以更好的用于后面的汉字识别。</p>
<h2 id="语序识别算法"><a href="#语序识别算法" class="headerlink" title="语序识别算法"></a>语序识别算法</h2><p>语序识别算法结合了<strong>使用结巴分词识别语序</strong>和<strong>使用搜索引擎识别语序</strong>两个函数，下面分别对两个函数进行讲解。</p>
<h3 id="使用结巴分词识别语序"><a href="#使用结巴分词识别语序" class="headerlink" title="使用结巴分词识别语序"></a>使用结巴分词识别语序</h3><p>本部分使用的是 Python 中文分词词库<code>jieba</code>，关于结巴分词的基础知识请先阅读<a href="https://github.com/fxsjy/jieba" target="_blank" rel="noopener">结巴分词Github文档</a>，下面对使用结巴分词识别语序进行讲解。</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 结巴分词 识别语序</span></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">recog_order_jieba</span><span class="params">(str)</span>:</span></span><br><span class="line">    l = len(str) <span class="comment"># l表示输入字符串个数</span></span><br><span class="line">    word_list = _permutation(str) <span class="comment"># 获得该字符串的所有排列方式</span></span><br><span class="line">    possible_words = [] <span class="comment"># 用来存放语序可能正确的词</span></span><br><span class="line">    <span class="keyword">for</span> word <span class="keyword">in</span> word_list:  <span class="comment"># 编列所有排列方式</span></span><br><span class="line">        seg_list = jieba.lcut(word, cut_all=<span class="keyword">True</span> ) <span class="comment"># 对某一种排列方式使用结巴分词</span></span><br><span class="line">        index = find_longest(seg_list)  <span class="comment"># 寻找结巴分词返回的列表中字符串最长的索引，并返回</span></span><br><span class="line">        <span class="keyword">if</span> len(seg_list[index]) == l: <span class="comment"># 若最长的字符串与输入的字符串长度相同，则加入可能正确列表</span></span><br><span class="line">            possible_words.append(seg_list[index])</span><br><span class="line">    <span class="keyword">if</span> len(possible_words) ==<span class="number">1</span>: <span class="comment"># 遍历完后，若可能正确的列表只有一个元素，那么他就是正确的，返回</span></span><br><span class="line">        <span class="keyword">return</span> possible_words[<span class="number">0</span>]</span><br><span class="line">    <span class="keyword">elif</span> len(possible_words) &gt;<span class="number">1</span>: <span class="comment"># 若有可能正确列表中若有多个元素，则选取词频高的返回</span></span><br><span class="line">        <span class="keyword">return</span> highest_frequency(possible_words)</span><br><span class="line">    <span class="keyword">else</span>: <span class="comment"># 如果可能正确的列表元素为0，则返回0</span></span><br><span class="line">        <span class="keyword">return</span> <span class="number">0</span> </span><br><span class="line">    </span><br><span class="line"><span class="comment"># 获得汉字的所有排列方式</span></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">_permutation</span><span class="params">(str, r = None)</span>:</span> </span><br><span class="line">    word_list = list(permutations(str, r))</span><br><span class="line">    <span class="keyword">for</span> i <span class="keyword">in</span> range(len(word_list)):</span><br><span class="line">        word_list[i] = <span class="string">''</span>.join(word_list[i])</span><br><span class="line">    <span class="keyword">return</span> word_list</span><br><span class="line"></span><br><span class="line"><span class="comment"># 寻找列表中最长的词</span></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">find_longest</span><span class="params">(list)</span>:</span></span><br><span class="line">    l = <span class="number">0</span></span><br><span class="line">    index = <span class="number">0</span></span><br><span class="line">    <span class="keyword">for</span> i,word <span class="keyword">in</span> enumerate(list):</span><br><span class="line">        <span class="keyword">if</span> len(word) &gt; l:</span><br><span class="line">            l = len(word)</span><br><span class="line">            index = i </span><br><span class="line">    <span class="keyword">return</span> index</span><br><span class="line"></span><br><span class="line"><span class="comment"># 输入词列表，返回结巴分词内词频最高的词</span></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">highest_frequency</span><span class="params">(possible_words)</span>:</span></span><br><span class="line">    word_dict = file2dict(<span class="string">'dict.txt'</span>) </span><br><span class="line">    possible_dict = &#123;&#125;</span><br><span class="line">    <span class="keyword">for</span> possible_word <span class="keyword">in</span> possible_words:</span><br><span class="line">        possible_dict[word_dict[possible_word]] = possible_word</span><br><span class="line">    sorted = sortedDictValues(possible_dict)</span><br><span class="line">    print(sortedList)</span><br><span class="line">    <span class="keyword">return</span> sortedList[<span class="number">-1</span>][<span class="number">1</span>]</span><br><span class="line"></span><br><span class="line"><span class="comment"># 对输入的字典根据key大小排序</span></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">sortedDictValues</span><span class="params">(di)</span>:</span> </span><br><span class="line">    <span class="keyword">return</span> [(k,di[k]) <span class="keyword">for</span> k <span class="keyword">in</span> sorted(di.keys())]</span><br><span class="line"></span><br><span class="line"><span class="comment"># 将文件数据转换为字典</span></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">file2dict</span><span class="params">(filename)</span>:</span></span><br><span class="line">    <span class="keyword">with</span> open(filename) <span class="keyword">as</span> f:</span><br><span class="line">        array_lines = f.readlines()</span><br><span class="line">    returnDict = &#123;&#125;</span><br><span class="line">    <span class="comment"># 以下三行解析文件数据到列表</span></span><br><span class="line">    <span class="keyword">for</span> line <span class="keyword">in</span> array_lines:</span><br><span class="line">        line = line.strip()</span><br><span class="line">        listFromLine = line.split()</span><br><span class="line">        returnDict[listFromLine[<span class="number">0</span>]] = int(listFromLine[<span class="number">1</span>])</span><br><span class="line">    <span class="keyword">return</span> returnDict</span><br></pre></td></tr></table></figure>
<p>下面我通过一个具体的实例来讲解算法思路:</p>
<p>输入：‘到马功成’</p>
<ol>
<li>获得字符串长度：</li>
</ol>
<p><code>l =4</code></p>
<ol>
<li><p>获得字符串的全排列</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">[<span class="string">'到马功成'</span>, <span class="string">'到马成功'</span>, <span class="string">'到功马成'</span>, <span class="string">'到功成马'</span>, <span class="string">'到成马功'</span>, <span class="string">'到成功马'</span>, <span class="string">'马到功成'</span>, <span class="string">'马到成功'</span>, <span class="string">'马功到成'</span>, <span class="string">'马功成到'</span>, <span class="string">'马成到功'</span>, <span class="string">'马成功到'</span>, <span class="string">'功到马成'</span>, <span class="string">'功到成马'</span>, <span class="string">'功马到成'</span>, <span class="string">'功马成到'</span>, <span class="string">'功成到马'</span>, <span class="string">'功成马到'</span>, <span class="string">'成到马功'</span>, <span class="string">'成到功马'</span>, <span class="string">'成马到功'</span>, <span class="string">'成马功到'</span>, <span class="string">'成功到马'</span>, <span class="string">'成功马到'</span>]</span><br></pre></td></tr></table></figure>
</li>
<li><p>对每一个排列进行结巴分词，并打印其中字符串最长元素的索引</p>
</li>
</ol>
   <figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br></pre></td><td class="code"><pre><span class="line">[<span class="string">'到'</span>, <span class="string">'马'</span>, <span class="string">'功'</span>, <span class="string">'成'</span>]</span><br><span class="line"><span class="number">0</span></span><br><span class="line">[<span class="string">'到'</span>, <span class="string">'马'</span>, <span class="string">'成功'</span>]</span><br><span class="line"><span class="number">2</span></span><br><span class="line">[<span class="string">'到'</span>, <span class="string">'功'</span>, <span class="string">'马'</span>, <span class="string">'成'</span>]</span><br><span class="line"><span class="number">0</span></span><br><span class="line">[<span class="string">'到'</span>, <span class="string">'功'</span>, <span class="string">'成'</span>, <span class="string">'马'</span>]</span><br><span class="line"><span class="number">0</span></span><br><span class="line">[<span class="string">'到'</span>, <span class="string">'成'</span>, <span class="string">'马'</span>, <span class="string">'功'</span>]</span><br><span class="line"><span class="number">0</span></span><br><span class="line">[<span class="string">'到'</span>, <span class="string">'成功'</span>, <span class="string">'马'</span>]</span><br><span class="line"><span class="number">1</span></span><br><span class="line">[<span class="string">'马到功成'</span>]</span><br><span class="line"><span class="number">0</span></span><br><span class="line">[<span class="string">'马到成功'</span>, <span class="string">'成功'</span>]</span><br><span class="line"><span class="number">0</span></span><br><span class="line">[<span class="string">'马'</span>, <span class="string">'功'</span>, <span class="string">'到'</span>, <span class="string">'成'</span>]</span><br><span class="line"><span class="number">0</span></span><br><span class="line">[<span class="string">'马'</span>, <span class="string">'功'</span>, <span class="string">'成'</span>, <span class="string">'到'</span>]</span><br><span class="line"><span class="number">0</span></span><br><span class="line">[<span class="string">'马'</span>, <span class="string">'成'</span>, <span class="string">'到'</span>, <span class="string">'功'</span>]</span><br><span class="line"><span class="number">0</span></span><br><span class="line">[<span class="string">'马'</span>, <span class="string">'成功'</span>, <span class="string">'到'</span>]</span><br><span class="line"><span class="number">1</span></span><br><span class="line">[<span class="string">'功'</span>, <span class="string">'到'</span>, <span class="string">'马'</span>, <span class="string">'成'</span>]</span><br><span class="line"><span class="number">0</span></span><br><span class="line">[<span class="string">'功'</span>, <span class="string">'到'</span>, <span class="string">'成'</span>, <span class="string">'马'</span>]</span><br><span class="line"><span class="number">0</span></span><br><span class="line">[<span class="string">'功'</span>, <span class="string">'马'</span>, <span class="string">'到'</span>, <span class="string">'成'</span>]</span><br><span class="line"><span class="number">0</span></span><br><span class="line">[<span class="string">'功'</span>, <span class="string">'马'</span>, <span class="string">'成'</span>, <span class="string">'到'</span>]</span><br><span class="line"><span class="number">0</span></span><br><span class="line">[<span class="string">'功'</span>, <span class="string">'成'</span>, <span class="string">'到'</span>, <span class="string">'马'</span>]</span><br><span class="line"><span class="number">0</span></span><br><span class="line">[<span class="string">'功'</span>, <span class="string">'成'</span>, <span class="string">'马'</span>, <span class="string">'到'</span>]</span><br><span class="line"><span class="number">0</span></span><br><span class="line">[<span class="string">'成'</span>, <span class="string">'到'</span>, <span class="string">'马'</span>, <span class="string">'功'</span>]</span><br><span class="line"><span class="number">0</span></span><br><span class="line">[<span class="string">'成'</span>, <span class="string">'到'</span>, <span class="string">'功'</span>, <span class="string">'马'</span>]</span><br><span class="line"><span class="number">0</span></span><br><span class="line">[<span class="string">'成'</span>, <span class="string">'马'</span>, <span class="string">'到'</span>, <span class="string">'功'</span>]</span><br><span class="line"><span class="number">0</span></span><br><span class="line">[<span class="string">'成'</span>, <span class="string">'马'</span>, <span class="string">'功'</span>, <span class="string">'到'</span>]</span><br><span class="line"><span class="number">0</span></span><br><span class="line">[<span class="string">'成功'</span>, <span class="string">'到'</span>, <span class="string">'马'</span>]</span><br><span class="line"><span class="number">0</span></span><br><span class="line">[<span class="string">'成功'</span>, <span class="string">'马'</span>, <span class="string">'到'</span>]</span><br><span class="line"><span class="number">0</span></span><br></pre></td></tr></table></figure>
<ol>
<li><p>遍历完之后，将l=4的字符串加入possible_words列表</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">[&apos;马到功成&apos;, &apos;马到成功&apos;] # possible_words列表</span><br></pre></td></tr></table></figure>
</li>
<li><p>现在有两个词语语序是可能正确的，由于结巴分词词库中的词语是有词频的，比如：</p>
</li>
</ol>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">......</span><br><span class="line">......</span><br><span class="line">马利诺夫斯基 3 nrt</span><br><span class="line">马到功成 3 i</span><br><span class="line">马到成功 313 i</span><br><span class="line">马刺进 2 nr</span><br><span class="line">......</span><br><span class="line">......</span><br></pre></td></tr></table></figure>
<p>每行的第二个元素代表词频，所以我们可以通过比较词频来确定最终的语序正确的词：</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">马到成功</span><br></pre></td></tr></table></figure>
<h3 id="使用搜索引擎识别语序"><a href="#使用搜索引擎识别语序" class="headerlink" title="使用搜索引擎识别语序"></a>使用搜索引擎识别语序</h3><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 搜索引擎搜索关键字,返回相关列表</span></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">search_engine</span><span class="params">(word)</span>:</span></span><br><span class="line">    headers = &#123;</span><br><span class="line">        <span class="string">'User-Agent'</span>: <span class="string">'Mozilla/5.0 (X11; Linux x86_64) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/66.0.3359.139 Safari/537.36'</span></span><br><span class="line">    &#125;</span><br><span class="line">    r = requests.get(<span class="string">'https://www.baidu.com/s?wd='</span> + word, headers=headers)</span><br><span class="line">    html = etree.HTML(r.text)</span><br><span class="line">    related_words1 = html.xpath(<span class="string">'//*[@id="rs"]/table//tr//th/a/text()'</span>)</span><br><span class="line">    related_words2 = html.xpath(<span class="string">'//div[@id="content_left"]//a//em/text()'</span>)</span><br><span class="line">    related_words = related_words1 + related_words2</span><br><span class="line">    <span class="keyword">return</span> related_words</span><br><span class="line">    </span><br><span class="line">    </span><br><span class="line"><span class="comment"># 调用一次线程，每一个线程对输入字符串进行百度搜索，返回相关词的列表</span></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">search</span><span class="params">(word)</span>:</span></span><br><span class="line">    related_words = search_engine(word)</span><br><span class="line">    <span class="keyword">global</span> all_related</span><br><span class="line">    all_related = all_related + related_words</span><br><span class="line"></span><br><span class="line"><span class="comment"># 通过搜索引擎识别语序</span></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">search_engine_recog</span><span class="params">(str)</span>:</span></span><br><span class="line">    word_list = _permutation(str) <span class="comment"># 获得排列</span></span><br><span class="line">    <span class="keyword">global</span> flags </span><br><span class="line">    flags = [<span class="number">0</span>] * len(word_list) <span class="comment"># 标志位</span></span><br><span class="line">    threads = []</span><br><span class="line"></span><br><span class="line">    <span class="keyword">for</span> word <span class="keyword">in</span> word_list: <span class="comment"># 遍历所有可能的排列组合，进行百度搜索</span></span><br><span class="line">        thread = threading.Thread(target=search, args=[word])</span><br><span class="line">        threads.append(thread)</span><br><span class="line">        thread.start()</span><br><span class="line">    <span class="keyword">for</span> thread <span class="keyword">in</span> threads:</span><br><span class="line">        thread.join()</span><br><span class="line">    <span class="keyword">global</span> all_related <span class="comment"># 记录所有排列组合进行百度搜索后返回的列表</span></span><br><span class="line">    <span class="keyword">for</span> i,word <span class="keyword">in</span> enumerate(word_list): <span class="comment"># 遍历所有排列</span></span><br><span class="line">        flag = <span class="number">0</span></span><br><span class="line">        <span class="keyword">for</span> related_word <span class="keyword">in</span> all_related: <span class="comment"># 对每一个排列统计在所有相关词语列表中出现的次数</span></span><br><span class="line">            <span class="keyword">if</span> word <span class="keyword">in</span> related_word:</span><br><span class="line">                    flag = flag + <span class="number">1</span></span><br><span class="line">        flags[i] = flag</span><br><span class="line">    all_related = [] <span class="comment"># 清空</span></span><br><span class="line">    index = flags.index(max(flags)) <span class="comment"># 找到标志位最大的索引</span></span><br><span class="line">    <span class="keyword">return</span> word_list[index]</span><br></pre></td></tr></table></figure>
<p>同样，这里仍然用一个实例来讲解该算法思路：</p>
<p>输入：’现无中意发’</p>
<ol>
<li>获得输入字符串的排列：</li>
</ol>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">[<span class="string">'现无中意发'</span>, <span class="string">'现无中发意'</span>, <span class="string">'现无意中发'</span>, <span class="string">'现无意发中'</span>, <span class="string">'现无发中意'</span>, <span class="string">'现无发意中'</span>, <span class="string">'现中无意发'</span>, <span class="string">'现中无发意'</span>, <span class="string">'现中意无发'</span>, <span class="string">'现中意发无'</span>, <span class="string">'现中发无意'</span>, <span class="string">'现中发意无'</span>, <span class="string">'现意无中发'</span>, <span class="string">'现意无发中'</span>, <span class="string">'现意中无发'</span>, <span class="string">'现意中发无'</span>, <span class="string">'现意发无中'</span>, <span class="string">'现意发中无'</span>, <span class="string">'现发无中意'</span>, <span class="string">'现发无意中'</span>, <span class="string">'现发中无意'</span>, <span class="string">'现发中意无'</span>, <span class="string">'现发意无中'</span>, <span class="string">'现发意中无'</span>, <span class="string">'无现中意发'</span>, <span class="string">'无现中发意'</span>, <span class="string">'无现意中发'</span>, <span class="string">'无现意发中'</span>, <span class="string">'无现发中意'</span>, <span class="string">'无现发意中'</span>, <span class="string">'无中现意发'</span>, <span class="string">'无中现发意'</span>, <span class="string">'无中意现发'</span>, <span class="string">'无中意发现'</span>, <span class="string">'无中发现意'</span>, <span class="string">'无中发意现'</span>, <span class="string">'无意现中发'</span>, <span class="string">'无意现发中'</span>, <span class="string">'无意中现发'</span>, <span class="string">'无意中发现'</span>, <span class="string">'无意发现中'</span>, <span class="string">'无意发中现'</span>, <span class="string">'无发现中意'</span>, <span class="string">'无发现意中'</span>, <span class="string">'无发中现意'</span>, <span class="string">'无发中意现'</span>, <span class="string">'无发意现中'</span>, <span class="string">'无发意中现'</span>, <span class="string">'中现无意发'</span>, <span class="string">'中现无发意'</span>, <span class="string">'中现意无发'</span>, <span class="string">'中现意发无'</span>, <span class="string">'中现发无意'</span>, <span class="string">'中现发意无'</span>, <span class="string">'中无现意发'</span>, <span class="string">'中无现发意'</span>, <span class="string">'中无意现发'</span>, <span class="string">'中无意发现'</span>, <span class="string">'中无发现意'</span>, <span class="string">'中无发意现'</span>, <span class="string">'中意现无发'</span>, <span class="string">'中意现发无'</span>, <span class="string">'中意无现发'</span>, <span class="string">'中意无发现'</span>, <span class="string">'中意发现无'</span>, <span class="string">'中意发无现'</span>, <span class="string">'中发现无意'</span>, <span class="string">'中发现意无'</span>, <span class="string">'中发无现意'</span>, <span class="string">'中发无意现'</span>, <span class="string">'中发意现无'</span>, <span class="string">'中发意无现'</span>, <span class="string">'意现无中发'</span>, <span class="string">'意现无发中'</span>, <span class="string">'意现中无发'</span>, <span class="string">'意现中发无'</span>, <span class="string">'意现发无中'</span>, <span class="string">'意现发中无'</span>, <span class="string">'意无现中发'</span>, <span class="string">'意无现发中'</span>, <span class="string">'意无中现发'</span>, <span class="string">'意无中发现'</span>, <span class="string">'意无发现中'</span>, <span class="string">'意无发中现'</span>, <span class="string">'意中现无发'</span>, <span class="string">'意中现发无'</span>, <span class="string">'意中无现发'</span>, <span class="string">'意中无发现'</span>, <span class="string">'意中发现无'</span>, <span class="string">'意中发无现'</span>, <span class="string">'意发现无中'</span>, <span class="string">'意发现中无'</span>, <span class="string">'意发无现中'</span>, <span class="string">'意发无中现'</span>, <span class="string">'意发中现无'</span>, <span class="string">'意发中无现'</span>, <span class="string">'发现无中意'</span>, <span class="string">'发现无意中'</span>, <span class="string">'发现中无意'</span>, <span class="string">'发现中意无'</span>, <span class="string">'发现意无中'</span>, <span class="string">'发现意中无'</span>, <span class="string">'发无现中意'</span>, <span class="string">'发无现意中'</span>, <span class="string">'发无中现意'</span>, <span class="string">'发无中意现'</span>, <span class="string">'发无意现中'</span>, <span class="string">'发无意中现'</span>, <span class="string">'发中现无意'</span>, <span class="string">'发中现意无'</span>, <span class="string">'发中无现意'</span>, <span class="string">'发中无意现'</span>, <span class="string">'发中意现无'</span>, <span class="string">'发中意无现'</span>, <span class="string">'发意现无中'</span>, <span class="string">'发意现中无'</span>, <span class="string">'发意无现中'</span>, <span class="string">'发意无中现'</span>, <span class="string">'发意中现无'</span>, <span class="string">'发意中无现'</span>]</span><br></pre></td></tr></table></figure>
<ol>
<li><p>对每一个排列进行百度搜索返回相关词。</p>
<p>其中的百度搜索是通过爬虫实现的，爬取的结点主要有两部分：1.每次搜索结果词条中红色的词。2.每次搜索结果最下面的相关搜索中的词。</p>
</li>
</ol>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">[<span class="string">'中意隆鑫航发基地'</span>, <span class="string">'我对你中意红包怎么发'</span>, <span class="string">'中意保险几号发工资'</span>, <span class="string">'当时不知曲中意现已成为曲中人'</span>, <span class="string">'中意空调现E5怎么办'</span>, <span class="string">'初闻不知曲中意现已成为曲中人'</span>, <span class="string">'中意'</span>, <span class="string">'中意在线'</span>, <span class="string">'初闻不知曲中意,再听已是曲中人'</span>, <span class="string">'发中意'</span>, <span class="string">'没有中意'</span>, <span class="string">'中意'</span>, <span class="string">'中意'</span>, <span class="string">'中意'</span>, <span class="string">'中意'</span>, <span class="string">'中意'</span>, <span class="string">'中意'</span>,<span class="string">'中意'</span>, <span class="string">'中意'</span>, <span class="string">'没有'</span>, <span class="string">'中意'</span>, <span class="string">'中意'</span>, <span class="string">'没有'</span>, <span class="string">'中意'</span>, <span class="string">'中意隆鑫航发基地'</span>, <span class="string">'我对你中意红包怎么发'</span>, <span class="string">'中意保险几号发工资'</span>, <span class="string">'当时不知曲中意现已成为曲中人'</span>, <span class="string">'中意空调现E5怎么办'</span>, <span class="string">'初闻不知曲中意现已成为曲中人'</span>, <span class="string">'中意'</span>, <span class="string">'中意在线'</span>, <span class="string">'初闻不知曲中意,再听已是曲中人'</span>, <span class="string">'现发中意无'</span>,<span class="string">'没有中意'</span>, <span class="string">'中意'</span>, <span class="string">'没有'</span>, <span class="string">'中意'</span>, <span class="string">'没有'</span>, <span class="string">'中意'</span>, <span class="string">'中意'</span>, <span class="string">'没有'</span>, <span class="string">'中意'</span>, <span class="string">'中意'</span>, <span class="string">'没有'</span>, <span class="string">'中意'</span>, <span class="string">'没有'</span>, <span class="string">'中意'</span>, <span class="string">'中发发型'</span>, <span class="string">'中发'</span>, <span class="string">'中发卷发'</span>, <span class="string">'中发烫发'</span>, <span class="string">'中发发型图片'</span>, <span class="string">'中发图片'</span>, <span class="string">'中发编发'</span>, <span class="string">'中发烫发图片'</span>, <span class="string">'中发白'</span>, <span class="string">'中发无意现'</span>, <span class="string">'中发'</span>, <span class="string">'中发'</span>, <span class="string">'无意'</span>, <span class="string">'中发'</span>, <span class="string">'中发'</span>, <span class="string">'中发'</span>, <span class="string">'中发'</span>, <span class="string">'中发'</span>, <span class="string">'中意隆鑫航发基地'</span>, <span class="string">'我对你中意红包怎么发'</span>, <span class="string">'中意保险几号发工资'</span>, <span class="string">'当时不知曲中意现已成为曲中人'</span>, <span class="string">'中意空调现E5怎么办'</span>, <span class="string">'初闻不知你'</span>, <span class="string">'中意在线用户登录'</span>, <span class="string">'我只中意你'</span>, <span class="string">'中意保险可靠吗'</span>, <span class="string">'中意'</span>, <span class="string">'中意'</span>, <span class="string">'中意'</span>, <span class="string">'无中意'</span>, <span class="string">'无中意'</span>, <span class="string">'中意'</span>, <span class="string">'发现'</span>, <span class="string">'中意'</span>, <span class="string">'中意'</span>, <span class="string">'无中意'</span>, <span class="string">'中意'</span>, <span class="string">'无中意'</span>, <span class="string">'意什么什么发'</span>, <span class="string">'意()()发'</span>, <span class="string">'发现的近意词是什么'</span>, <span class="string">'发现的进意词'</span>, <span class="string">'发现意'</span>, <span class="string">'微信里的发现是什么意是'</span>, <span class="string">'意料之中什么意思'</span>, <span class="string">'中译意'</span>,  <span class="string">'发现'</span>, <span class="string">'无意中发现'</span>, </span><br><span class="line"> ......................................................................................</span><br><span class="line"> ......................all_realated列表比较长，中间部分的词省略............................</span><br><span class="line"> .....................................................................................</span><br><span class="line"> <span class="string">'无意'</span>, <span class="string">'发现'</span>, <span class="string">'无意中发现'</span>, <span class="string">'无意中发现'</span>, <span class="string">'无意中'</span>, <span class="string">'无意中发现'</span>,  <span class="string">'初闻不知曲中意现已成为曲中人'</span>, <span class="string">'中意'</span>, <span class="string">'中意在线'</span>, <span class="string">'初闻不知曲中意,再听已是曲中人'</span>, <span class="string">'发中意无'</span>, <span class="string">'没有中意'</span>, <span class="string">'中意'</span>, <span class="string">'无中意'</span>, <span class="string">'没有'</span>, <span class="string">'中意'</span>, <span class="string">'没有中意'</span>, <span class="string">'中意'</span>, <span class="string">'没有'</span>, <span class="string">'中意'</span>, <span class="string">'中意'</span>, <span class="string">'没有'</span>, <span class="string">'中意隆鑫航发基地'</span>, <span class="string">'我对你中意红包怎么发'</span>, <span class="string">'中意保险几号发工资'</span>, <span class="string">'当时不知曲中意现已成为曲中人'</span>, <span class="string">'中意空调现E5怎么办'</span>,  <span class="string">'意无限'</span>, <span class="string">'意无限'</span>, <span class="string">'意无限'</span>, <span class="string">'意无限'</span>, <span class="string">'意无限'</span>, <span class="string">'意无限'</span>, <span class="string">'意无限'</span>, <span class="string">'有意瞄准无意击发'</span>, <span class="string">'无意击发'</span>, <span class="string">'有意瞄准无意击发意思'</span>, <span class="string">'有意激无意发'</span>, <span class="string">'无意和别人换了鞋有什么说发'</span>, <span class="string">'无意发了视频'</span>, <span class="string">'有意瞄准,无意击发解释'</span>, <span class="string">'有意瞄准无意击发柴静'</span>, <span class="string">'无意栽花犹发蕊'</span>, <span class="string">'无意'</span>, <span class="string">'无意'</span>, <span class="string">'无意'</span>, <span class="string">'中无意'</span>, <span class="string">'无意'</span>, <span class="string">'无意'</span>, <span class="string">'无意'</span>, <span class="string">'发发'</span>, <span class="string">'无意'</span>, <span class="string">'无意'</span>, <span class="string">'中无意'</span>, <span class="string">'无意'</span>, <span class="string">'意什么什么发'</span>, <span class="string">'意()()发'</span>, <span class="string">'发意生是什么意思'</span>, <span class="string">'发意症'</span>, <span class="string">'意发'</span>, <span class="string">'意发游戏'</span>, <span class="string">'意什么发成语接龙'</span>, <span class="string">'向发意'</span>, <span class="string">'意发股份'</span>, <span class="string">'无意中'</span>, <span class="string">'无意中'</span>, <span class="string">'无意中'</span>, <span class="string">'无意中'</span>, <span class="string">'无意中'</span>, <span class="string">'无意中'</span>, <span class="string">'无意中'</span>, <span class="string">'无意中'</span>, <span class="string">'无意中'</span>, <span class="string">'无意中'</span>, <span class="string">'无意中'</span>, <span class="string">'无意中'</span>, <span class="string">'意什么什么发'</span>, <span class="string">'意()()发'</span>, <span class="string">'发意生是什么意思'</span>, <span class="string">'发意症'</span>, <span class="string">'意发'</span>, <span class="string">'意发游戏'</span>, <span class="string">'意什么发成语接龙'</span>, <span class="string">'向发意'</span>, <span class="string">'意发股份'</span>, <span class="string">'无意'</span>, <span class="string">'无意'</span>, <span class="string">'无意'</span>, <span class="string">'无意'</span>, <span class="string">'没有'</span>, <span class="string">'无意'</span>, <span class="string">'无意'</span>, <span class="string">'无意'</span>, <span class="string">'发发无意'</span>, <span class="string">'无意'</span>, <span class="string">'意什么什么发'</span>, <span class="string">'意()()发'</span>, <span class="string">'发意生是什么意思'</span>, <span class="string">'发意症'</span>, <span class="string">'意发'</span>, <span class="string">'意发游戏'</span>, <span class="string">'意什么发成语接龙'</span>, <span class="string">'向发意'</span>, <span class="string">'意发股份'</span>, <span class="string">'意中'</span>, <span class="string">'意中'</span>, <span class="string">'意中'</span>, <span class="string">'意中'</span>, <span class="string">'意中'</span>, <span class="string">'意中'</span>, <span class="string">'意中'</span>, <span class="string">'意中'</span>, <span class="string">'意中'</span>, <span class="string">'意中'</span>, <span class="string">'意中'</span>, <span class="string">'发意中现无'</span>, <span class="string">'意中'</span>, <span class="string">'意中'</span>, <span class="string">'意中'</span>, <span class="string">'意什么什么发'</span>, <span class="string">'意()()发'</span>, <span class="string">'发意生是什么意思'</span>, <span class="string">'发意症'</span>, <span class="string">'意发'</span>, <span class="string">'意发游戏'</span>, <span class="string">'意什么发成语接龙'</span>, <span class="string">'向发意'</span>, <span class="string">'意发股份'</span>, <span class="string">'意中'</span>, <span class="string">'意中'</span>, <span class="string">'意中'</span>, <span class="string">'意中'</span>, <span class="string">'意中'</span>, <span class="string">'意中'</span>, <span class="string">'意中'</span>, <span class="string">'意中'</span>, <span class="string">'意中'</span>, <span class="string">'意中'</span>, <span class="string">'发意中无现'</span>, <span class="string">'意中'</span>, <span class="string">'意中'</span>]</span><br></pre></td></tr></table></figure>
<ol>
<li>通过一个嵌套循环来统计每一个排列在all_relalated列表中出现的次数（排列是列表元素的子串）。</li>
</ol>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">[<span class="number">0</span>, <span class="number">0</span>, <span class="number">0</span>, <span class="number">0</span>, <span class="number">0</span>, <span class="number">1</span>, <span class="number">0</span>, <span class="number">0</span>, <span class="number">0</span>, <span class="number">0</span>, <span class="number">0</span>, <span class="number">0</span>, <span class="number">0</span>, <span class="number">1</span>, <span class="number">1</span>, <span class="number">0</span>, <span class="number">0</span>, <span class="number">0</span>, <span class="number">0</span>, <span class="number">0</span>, <span class="number">0</span>, <span class="number">9</span>, <span class="number">0</span>, <span class="number">0</span>, <span class="number">0</span>, <span class="number">0</span>, <span class="number">0</span>, <span class="number">0</span>, <span class="number">0</span>, <span class="number">0</span>, <span class="number">0</span>, <span class="number">0</span>, <span class="number">0</span>, <span class="number">0</span>, <span class="number">0</span>, <span class="number">0</span>, <span class="number">0</span>, <span class="number">0</span>, <span class="number">0</span>, <span class="number">125</span>, <span class="number">0</span>, <span class="number">0</span>, <span class="number">0</span>, <span class="number">0</span>, <span class="number">1</span>,<span class="number">0</span>, <span class="number">0</span>, <span class="number">0</span>, <span class="number">0</span>, <span class="number">0</span>, <span class="number">0</span>, <span class="number">0</span>, <span class="number">0</span>, <span class="number">0</span>, <span class="number">0</span>, <span class="number">0</span>, <span class="number">1</span>, <span class="number">7</span>, <span class="number">0</span>, <span class="number">0</span>, <span class="number">0</span>, <span class="number">0</span>, <span class="number">0</span>, <span class="number">0</span>, <span class="number">0</span>, <span class="number">0</span>, <span class="number">0</span>, <span class="number">0</span>, <span class="number">0</span>, <span class="number">12</span>, <span class="number">0</span>, <span class="number">0</span>, <span class="number">0</span>, <span class="number">0</span>, <span class="number">0</span>, <span class="number">0</span>, <span class="number">0</span>, <span class="number">0</span>, <span class="number">0</span>, <span class="number">0</span>, <span class="number">1</span>, <span class="number">0</span>, <span class="number">0</span>, <span class="number">0</span>, <span class="number">1</span>, <span class="number">1</span>, <span class="number">0</span>, <span class="number">0</span>, <span class="number">0</span>, <span class="number">0</span>, <span class="number">0</span>, <span class="number">0</span>, <span class="number">0</span>, <span class="number">0</span>, <span class="number">0</span>, <span class="number">0</span>, <span class="number">1</span>, <span class="number">0</span>, <span class="number">0</span>, <span class="number">0</span>, <span class="number">0</span>, <span class="number">0</span>, <span class="number">0</span>, <span class="number">0</span>, <span class="number">0</span>, <span class="number">0</span>, <span class="number">0</span>, <span class="number">0</span>, <span class="number">1</span>, <span class="number">0</span>, <span class="number">0</span>, <span class="number">0</span>, <span class="number">0</span>, <span class="number">0</span>, <span class="number">0</span>, <span class="number">0</span>, <span class="number">0</span>, <span class="number">0</span>, <span class="number">1</span>, <span class="number">1</span>]</span><br></pre></td></tr></table></figure>
<ol>
<li>找到标志位最大的索引，返回word_list列表中该索引值对应的排列。</li>
</ol>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">无意中发现</span><br></pre></td></tr></table></figure>
<h2 id="完整破解程序"><a href="#完整破解程序" class="headerlink" title="完整破解程序"></a>完整破解程序</h2><h3 id="程序讲解"><a href="#程序讲解" class="headerlink" title="程序讲解"></a>程序讲解</h3><p>通过多次试验会发现，使用结巴分词识别语序和搜索引擎识别语序各有利弊，使用结巴分词的优点是速度很快，缺点是对于一些不是词语的语序识别会识别不出来。而搜索引擎识别语序，语序识别能力强，但是比较慢。所以在破解程序中我将二者结合了一下，充分使用了各自的优点。</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># -*- coding: utf-8 -*-</span></span><br><span class="line"><span class="keyword">from</span> darknet <span class="keyword">import</span> load_net, load_meta, detect, classify, load_image</span><br><span class="line"><span class="keyword">from</span> segment <span class="keyword">import</span> seg_one_img, load_dtc_module</span><br><span class="line"><span class="keyword">from</span> recog_order <span class="keyword">import</span> search_engine_recog, recog_order_jieba</span><br><span class="line"><span class="keyword">import</span> time</span><br><span class="line"><span class="keyword">import</span> cv2</span><br><span class="line"><span class="keyword">from</span> PIL <span class="keyword">import</span> Image</span><br><span class="line"><span class="keyword">import</span> numpy <span class="keyword">as</span> np</span><br><span class="line"><span class="keyword">import</span> copy</span><br><span class="line"><span class="keyword">import</span> os</span><br><span class="line"><span class="keyword">from</span> itertools <span class="keyword">import</span> permutations</span><br><span class="line"><span class="keyword">from</span> functools <span class="keyword">import</span> reduce</span><br><span class="line"></span><br><span class="line"><span class="comment"># 求多个列表的组合</span></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">combination</span><span class="params">(*lists)</span>:</span> </span><br><span class="line">    total = reduce(<span class="keyword">lambda</span> x, y: x * y, map(len, lists)) </span><br><span class="line">    retList = [] </span><br><span class="line">    <span class="keyword">for</span> i <span class="keyword">in</span> range(<span class="number">0</span>, total): </span><br><span class="line">        step = total </span><br><span class="line">        tempItem = [] </span><br><span class="line">        <span class="keyword">for</span> l <span class="keyword">in</span> lists: </span><br><span class="line">            step /= len(l) </span><br><span class="line">            tempItem.append(l[int(i/step % len(l))]) </span><br><span class="line">        retList.append(tuple(tempItem)) </span><br><span class="line">    <span class="keyword">return</span> retList </span><br><span class="line"></span><br><span class="line"><span class="comment"># 加载模块</span></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">load_clasiify_module</span><span class="params">(cfg, weights, data)</span>:</span></span><br><span class="line">    net = load_net(cfg, weights, <span class="number">0</span>)</span><br><span class="line">    meta = load_meta(data)</span><br><span class="line">    <span class="keyword">return</span> net, meta   </span><br><span class="line"></span><br><span class="line"><span class="comment"># 使用新字典记录坐标,注意字典是无序的！！</span></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">recordCoordinate</span><span class="params">(wordList, hanziList)</span>:</span></span><br><span class="line">    center = &#123;&#125;</span><br><span class="line">    <span class="keyword">for</span> i <span class="keyword">in</span> range(len(wordList)):</span><br><span class="line">        center[wordList[i]] = [center <span class="keyword">for</span> center <span class="keyword">in</span> hanziList[i].values()][<span class="number">0</span>]</span><br><span class="line">    <span class="keyword">return</span> center</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment"># 破解函数</span></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">crack</span><span class="params">(img_path, dtc_modu, classify_modu, k)</span>:</span></span><br><span class="line">    <span class="comment"># 定位汉字,得到多个矩形框</span></span><br><span class="line">    print(<span class="string">'\n'</span>*<span class="number">2</span> + <span class="string">'定位汉字'</span> + <span class="string">'\n'</span> + <span class="string">'*'</span>*<span class="number">80</span>)</span><br><span class="line">    d = time.time()</span><br><span class="line">    rets = detect(dtc_modu[<span class="number">0</span>], dtc_modu[<span class="number">1</span>], img_path.encode()) </span><br><span class="line">    print(<span class="string">'定位汉字耗时&#123;&#125;'</span>.format(time.time() - d))</span><br><span class="line">    l = len(rets)</span><br><span class="line">    <span class="comment"># 设置阈值</span></span><br><span class="line">    <span class="keyword">if</span> l &gt; k:</span><br><span class="line">        <span class="keyword">return</span> <span class="number">0</span></span><br><span class="line"></span><br><span class="line">    <span class="comment"># 切割图片，得到切割后的汉字图片</span></span><br><span class="line">    print(<span class="string">'\n'</span>*<span class="number">2</span> + <span class="string">'切割图片'</span> + <span class="string">'\n'</span> + <span class="string">'*'</span>*<span class="number">80</span>)</span><br><span class="line">    s = time.time()</span><br><span class="line">    hanzi_list = seg_one_img(img_path, rets)</span><br><span class="line">    print(hanzi_list)</span><br><span class="line">    print(<span class="string">'切割图片耗时&#123;&#125;'</span>.format(time.time() - s))</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">    <span class="comment"># 汉字识别，得到汉字字符串</span></span><br><span class="line">    print(<span class="string">'\n'</span>*<span class="number">2</span> + <span class="string">'汉字识别'</span> + <span class="string">'\n'</span> + <span class="string">'*'</span>*<span class="number">80</span>)</span><br><span class="line">    r = time.time()</span><br><span class="line">    all_hanzi_lists = [] <span class="comment"># 存储所有汉字的列表</span></span><br><span class="line">    <span class="comment"># 提取路径存入列表</span></span><br><span class="line">    paths = []</span><br><span class="line">    <span class="keyword">for</span> per <span class="keyword">in</span> hanzi_list:</span><br><span class="line">        paths.extend([i <span class="keyword">for</span> i <span class="keyword">in</span> per.keys()])</span><br><span class="line">        </span><br><span class="line">    <span class="keyword">for</span> path <span class="keyword">in</span> paths: <span class="comment"># 对切割的汉字图片进行遍历</span></span><br><span class="line">        hanzis = []</span><br><span class="line">        img = load_image(path.encode(), <span class="number">0</span> , <span class="number">0</span>)</span><br><span class="line">        res = classify(classify_modu[<span class="number">0</span>], classify_modu[<span class="number">1</span>], img)</span><br><span class="line">        print(res[<span class="number">0</span>:<span class="number">5</span>])</span><br><span class="line">        <span class="keyword">if</span> res[<span class="number">0</span>][<span class="number">1</span>] &lt; <span class="number">0.95</span>: <span class="comment"># 对置信度&lt;0.95的汉字</span></span><br><span class="line">            <span class="keyword">for</span> hz <span class="keyword">in</span> res[<span class="number">0</span>:<span class="number">5</span>]: <span class="comment"># 对识别的top5进行遍历,此处可修改</span></span><br><span class="line">                hanzi = (<span class="string">'\\'</span> + hz[<span class="number">0</span>].decode(<span class="string">'utf-8'</span>)).encode(<span class="string">'utf-8'</span>).decode(<span class="string">'unicode_escape'</span>) </span><br><span class="line">                hanzis.append(hanzi)</span><br><span class="line">        <span class="keyword">else</span>:</span><br><span class="line">            hanzi = (<span class="string">'\\'</span> + res[<span class="number">0</span>][<span class="number">0</span>].decode(<span class="string">'utf-8'</span>)).encode(<span class="string">'utf-8'</span>).decode(<span class="string">'unicode_escape'</span>)</span><br><span class="line">            hanzis.append(hanzi)</span><br><span class="line">        all_hanzi_lists.append(hanzis)  </span><br><span class="line">    print(all_hanzi_lists)</span><br><span class="line">    hanzi_combination =  combination(*all_hanzi_lists)</span><br><span class="line">    hanzi_combination_connect = []</span><br><span class="line">    <span class="keyword">for</span> words <span class="keyword">in</span> hanzi_combination:</span><br><span class="line">        hanzi_combination_connect.append(<span class="string">''</span>.join(words))</span><br><span class="line">    print(hanzi_combination_connect)</span><br><span class="line">    print(<span class="string">'汉字识别耗时&#123;&#125;'</span>.format(time.time() - r))</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">    <span class="comment"># 识别语序</span></span><br><span class="line">    hanzi_center = []</span><br><span class="line">    jieba_flag = <span class="number">0</span></span><br><span class="line">    o = time.time()</span><br><span class="line">    print(<span class="string">'\n'</span>*<span class="number">2</span> + <span class="string">'语序识别'</span> + <span class="string">'\n'</span> + <span class="string">'*'</span>*<span class="number">80</span>)</span><br><span class="line">    <span class="keyword">for</span> words <span class="keyword">in</span> hanzi_combination_connect: <span class="comment"># 对每一个组合进行结巴分词</span></span><br><span class="line">        <span class="comment"># 此处对汉字的坐标进行记录</span></span><br><span class="line">        hanzi_center = recordCoordinate(words, hanzi_list)</span><br><span class="line">        print(hanzi_center, <span class="string">'jiaba'</span>)</span><br><span class="line">        o = time.time()</span><br><span class="line">        rec_word_possible = recog_order_jieba(words)</span><br><span class="line">        <span class="keyword">if</span> rec_word_possible: <span class="comment"># 如果遇到正确的词，则标志位置1</span></span><br><span class="line">            jieba_flag = <span class="number">1</span> </span><br><span class="line">            <span class="keyword">break</span></span><br><span class="line">    <span class="keyword">if</span> jieba_flag:</span><br><span class="line">        rec_word = rec_word_possible</span><br><span class="line">    <span class="keyword">else</span>:</span><br><span class="line">        hanzi_center = recordCoordinate(hanzi_combination_connect[<span class="number">0</span>], hanzi_list)</span><br><span class="line">        print(hanzi_center,<span class="string">'engine'</span>)</span><br><span class="line">        rec_word = search_engine_recog(hanzi_combination_connect[<span class="number">0</span>])</span><br><span class="line">    print(<span class="string">'语序识别结果:&#123;&#125;'</span>.format(rec_word))</span><br><span class="line">    print(<span class="string">'语序识别耗时&#123;&#125;'</span>.format(time.time() - o))</span><br><span class="line"></span><br><span class="line">    <span class="comment"># 按正确语序输出坐标</span></span><br><span class="line">    print(<span class="string">'\n'</span>*<span class="number">2</span> + <span class="string">'最终结果'</span> + <span class="string">'\n'</span> + <span class="string">'*'</span>*<span class="number">80</span>)</span><br><span class="line">    centers = []</span><br><span class="line">    <span class="keyword">for</span> i <span class="keyword">in</span> rec_word:</span><br><span class="line">        centers.append(hanzi_center[i])</span><br><span class="line">    print(<span class="string">'正确语序的坐标：&#123;&#125;'</span>.format(centers))</span><br><span class="line">    print(<span class="string">'总耗时&#123;&#125;'</span>.format(time.time() - d))</span><br><span class="line">    print(rec_word)</span><br><span class="line">    <span class="keyword">return</span> centers</span><br></pre></td></tr></table></figure>
<p>下面依然用一个实例来讲解破解程序思路：</p>
<p>输入：</p>
<p><img src="/2018/11/19/破解含语序问题的点击验证码/crack.jpg" alt="破解图片"></p>
<p>1.使用汉字定位模型定位汉字，得到4个定位框信息，每个定位框的第一个元素为hanzi类，第二个元素为该定位框的置信度，第三个元素为定位框的归一化坐标信息（x，y，w，h）。</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">[(<span class="string">b'hanzi'</span>, <span class="number">0.8764635920524597</span>, (<span class="number">0.672152578830719</span>, <span class="number">0.355495423078537</span>, <span class="number">0.17341256141662598</span>, <span class="number">0.16976206004619598</span>)), (<span class="string">b'hanzi'</span>, <span class="number">0.8573136329650879</span>, (<span class="number">0.625790536403656</span>, <span class="number">0.7956624627113342</span>, <span class="number">0.15850003063678741</span>, <span class="number">0.13232673704624176</span>)), (<span class="string">b'hanzi'</span>, <span class="number">0.857090175151825</span>, (<span class="number">0.8480002284049988</span>, <span class="number">0.5595549941062927</span>, <span class="number">0.18965952098369598</span>, <span class="number">0.1373395025730133</span>)), (<span class="string">b'hanzi'</span>, <span class="number">0.8561009168624878</span>, (<span class="number">0.29499194025993347</span>, <span class="number">0.49679434299468994</span>, <span class="number">0.16142778098583221</span>, <span class="number">0.16253654658794403</span>))]</span><br></pre></td></tr></table></figure>
<p>2.根据定位框切割图片，输出由字典组成的列表（<code>key</code>为汉字图片的相对路径，<code>value</code>为汉字的中心坐标）。</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">[&#123;<span class="string">'hanzi_img/15343037353537.jpg'</span>: (<span class="number">231</span>, <span class="number">136</span>)&#125;, &#123;<span class="string">'hanzi_img/15343037353541.jpg'</span>: (<span class="number">215</span>, <span class="number">305</span>)&#125;, &#123;<span class="string">'hanzi_img/15343037353543.jpg'</span>: (<span class="number">291</span>, <span class="number">214</span>)&#125;, &#123;<span class="string">'hanzi_img/15343037353546.jpg'</span>: (<span class="number">101</span>, <span class="number">190</span>)&#125;]</span><br></pre></td></tr></table></figure>
<p>3.使用汉字识别模型识别汉字，因为汉字识别会有识别错误的情况出现，为了一定程度上纠正错误，我们针对汉字识别置信度小于0.95的汉字，先选取其top5，然后对汉字识别结果的这几个字进行组合。</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">[(<span class="string">b'u7269'</span>, <span class="number">0.9999469518661499</span>), (<span class="string">b'u7545'</span>, <span class="number">1.4645341252617072e-05</span>), (<span class="string">b'u626c'</span>, <span class="number">8.120928214339074e-06</span>), (<span class="string">b'u629b'</span>, <span class="number">6.87056399328867e-06</span>), (<span class="string">b'u573a'</span>, <span class="number">5.69164603803074e-06</span>)]</span><br><span class="line">[(<span class="string">b'u4e73'</span>, <span class="number">0.8303858637809753</span>), (<span class="string">b'u96c5'</span>, <span class="number">0.015525326132774353</span>), (<span class="string">b'u90e8'</span>, <span class="number">0.015043874271214008</span>), (<span class="string">b'u578b'</span>, <span class="number">0.008989457972347736</span>), (<span class="string">b'u64ad'</span>, <span class="number">0.008476710878312588</span>)]</span><br><span class="line">[(<span class="string">b'u52a8'</span>, <span class="number">0.9996626377105713</span>), (<span class="string">b'u5e7c'</span>, <span class="number">7.360828021774068e-05</span>), (<span class="string">b'u7ead'</span>, <span class="number">3.684992407215759e-05</span>), (<span class="string">b'u9645'</span>, <span class="number">2.4325390768353827e-05</span>), (<span class="string">b'u529f'</span>, <span class="number">2.07898483495228e-05</span>)]</span><br><span class="line">[(<span class="string">b'u901a'</span>, <span class="number">0.5683982372283936</span>), (<span class="string">b'u57d4'</span>, <span class="number">0.09509918093681335</span>), (<span class="string">b'u94fa'</span>, <span class="number">0.0750967487692833</span>), (<span class="string">b'u54fa'</span>, <span class="number">0.02881033532321453</span>),(<span class="string">b'u5398'</span>, <span class="number">0.009910903871059418</span>)]</span><br></pre></td></tr></table></figure>
<p>可以发现第二个和第四个汉字的置信度低于0.95，对置信度低于0.95的汉字选取其top5。</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">[[<span class="string">'物'</span>], [<span class="string">'乳'</span>, <span class="string">'雅'</span>, <span class="string">'部'</span>, <span class="string">'型'</span>, <span class="string">'播'</span>], [<span class="string">'动'</span>], [<span class="string">'通'</span>, <span class="string">'埔'</span>, <span class="string">'铺'</span>, <span class="string">'哺'</span>, <span class="string">'厘'</span>]]</span><br></pre></td></tr></table></figure>
<p>可以发现，若仅选取置信度最高的，汉字识别结果是<code>物，乳，动，通</code>，这样就是识别错了。所以我们对置信度低的先选取其top5。</p>
<p>对四个汉字列表进行组合得到：</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">[<span class="string">'物乳动通'</span>, <span class="string">'物乳动埔'</span>, <span class="string">'物乳动铺'</span>, <span class="string">'物乳动哺'</span>, <span class="string">'物乳动厘'</span>, <span class="string">'物雅动通'</span>, <span class="string">'物雅动埔'</span>, <span class="string">'物雅动铺'</span>, <span class="string">'物雅动哺'</span>, <span class="string">'物雅动厘'</span>, <span class="string">'物部动通'</span>, <span class="string">'物部动埔'</span>, <span class="string">'物部动铺'</span>, <span class="string">'物部动哺'</span>, <span class="string">'物部动厘'</span>, <span class="string">'物型动通'</span>, <span class="string">'物型动埔'</span>, <span class="string">'物型动铺'</span>, <span class="string">'物型动哺'</span>, <span class="string">'物型动厘'</span>, <span class="string">'物播动通'</span>, <span class="string">'物播动埔'</span>, <span class="string">'物播动铺'</span>, <span class="string">'物播动哺'</span>, <span class="string">'物播动厘'</span>]</span><br></pre></td></tr></table></figure>
<p>4.结合结巴分词和搜索引擎识别语序。对上一步中获得的组合进行遍历，先使用结巴分词识别语序，若结巴分词能识别出来，则直接返回；若结巴分词识别不出来，则仅对置信度最高的组合使用搜索引擎识别语序，将识别结果返回。本例中，结巴分词能正确识别，返回：</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">哺乳动物</span><br></pre></td></tr></table></figure>
<p>5.返回汉字对应的坐标。</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">[(101, 190), (215, 305), (291, 214), (231, 136)]</span><br></pre></td></tr></table></figure>
<p><strong>总结：</strong>结巴分词识别一种汉字组合语序的时间大约为：0.000××（和电脑配置有关系），所以对多个组合进行遍历耗时也不会很多。而使用搜索引擎对一种组合识别语序耗时1-15妙（根据汉字个数有所不同），所以在结巴分词识别不出来时，仅对置信度最高的组合进行搜索引擎识别语序。这样的话，整体情况会比较不错。大部分语序识别耗时在1s以内，少部分通过搜索引擎识别的则会耗时2-16秒内，根据汉字个数有多不同。</p>
<h3 id="测试正确率"><a href="#测试正确率" class="headerlink" title="测试正确率"></a>测试正确率</h3><p><strong>文件准备：</strong></p>
<p><code>python/valid</code>文件和<code>python/valid.txt</code>文件，其中<code>python/valid</code>文件内存放的是验证码图片，<code>python/valid.txt</code>内存放的是验证码图片文件名及其对应的正确语序，如下：</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">......</span><br><span class="line">......</span><br><span class="line">verifyCode1531875004.jpg--研究委员会</span><br><span class="line">verifyCode1531873597.jpg--求才若渴</span><br><span class="line">verifyCode1531874810.jpg--不久的将来</span><br><span class="line">......</span><br><span class="line">......</span><br></pre></td></tr></table></figure>
<p><strong>测试脚本：</strong></p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 加载汉字定位模型</span></span><br><span class="line">print(<span class="string">'\n'</span>*<span class="number">2</span> + <span class="string">'加载模型'</span> + <span class="string">'\n'</span> + <span class="string">'*'</span>*<span class="number">80</span>)</span><br><span class="line">dtc_modu = load_dtc_module(<span class="string">b'../cfg/yolo-origin.cfg'</span>,</span><br><span class="line">                            <span class="string">b'../jiyan/backup/yolo-origin_49200.weights'</span>, <span class="string">b'../cfg/yolo-origin.data'</span>) </span><br><span class="line"><span class="comment"># 加载汉字识别模型</span></span><br><span class="line">classify_modu = load_clasiify_module(<span class="string">b"../cfg/chinese_character.cfg"</span>, </span><br><span class="line">                    <span class="string">b"../chinese_classify/backup/chinese_character.backup"</span>, <span class="string">b"../cfg/chinese.data"</span>)</span><br><span class="line">cwd = os.getcwd()</span><br><span class="line">IMG_DIR = cwd.replace(<span class="string">"python"</span>, <span class="string">"python/valid/"</span>)</span><br><span class="line"><span class="keyword">with</span> open(<span class="string">'valid.txt'</span>)<span class="keyword">as</span> f:</span><br><span class="line">    lines = f.readlines()</span><br><span class="line">right = <span class="number">0</span></span><br><span class="line">num = len(lines)</span><br><span class="line"><span class="keyword">for</span> line <span class="keyword">in</span> lines:</span><br><span class="line">    line = line.strip()</span><br><span class="line">    rec_word = crack(IMG_DIR + line[:<span class="number">24</span>], dtc_modu, classify_modu, <span class="number">5</span>)</span><br><span class="line">    <span class="keyword">if</span> rec_word == line[<span class="number">26</span>:]:</span><br><span class="line">        right = right + <span class="number">1</span></span><br><span class="line">    <span class="keyword">elif</span> rec_word == <span class="number">0</span>:</span><br><span class="line">        num = num - <span class="number">1</span></span><br><span class="line">    <span class="keyword">else</span>:</span><br><span class="line">        print(<span class="string">'#'</span>*<span class="number">20</span> + line[<span class="number">26</span>:]+<span class="string">' '</span> + rec_word)</span><br><span class="line">print(<span class="string">'正确率=&#123;&#125;'</span>.format(right/num))</span><br></pre></td></tr></table></figure>
<p><strong>注意：</strong>测试接口正确率的时候，需要将破解接口最后的返回值<code>return centers</code>改为<code>return rec_word</code>。</p>
<hr>
<h1 id="模型训练文档"><a href="#模型训练文档" class="headerlink" title="模型训练文档"></a>模型训练文档</h1><p>本部分主要讲解如何使用<strong>定位器</strong>和<strong>分类器</strong>，其中包括<strong>训练数据准备</strong>、<strong>模型训练</strong>以及<strong>训练结果评估</strong>。</p>
<h2 id="依赖"><a href="#依赖" class="headerlink" title="依赖"></a>依赖</h2><ol>
<li>python3.6</li>
<li>opencv3</li>
<li>numpy</li>
</ol>
<h2 id="文件结构"><a href="#文件结构" class="headerlink" title="文件结构"></a>文件结构</h2><p>该文件结构图仅列出了一些比较重要的文件，并对文件作用进行了注解。<br><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br></pre></td><td class="code"><pre><span class="line">.</span><br><span class="line">├──Makefile								darknet配置文件</span><br><span class="line">├──README.md</span><br><span class="line">├── cfg</span><br><span class="line">│   ├── chinese.data                    分类器训练配置文件   </span><br><span class="line">│   ├── chinese_character.cfg			分类器网络配置文件</span><br><span class="line">│   ├── yolo-origin.cfg					YOLOV2定位器网络配置文件</span><br><span class="line">│   ├── yolo-origin.data				YOLOV2定位器训练配置文件</span><br><span class="line">│   ├── yolov3.cfg						YOLOV3定位器网络配置文件</span><br><span class="line">|	└── yolov3.data						YOLOV3定位器训练配置文件</span><br><span class="line">├── chinese_classify</span><br><span class="line">│   ├── backup 							分类器权重存储文件</span><br><span class="line">│   ├── data							</span><br><span class="line">│   │   ├── train						分类器训练集</span><br><span class="line">│   │   ├── valid						分类器验证集</span><br><span class="line">│   │   ├── labels.txt					分类器所有训练样本的标签</span><br><span class="line">│   │   ├── train.list					分类器所有训练样本的路径</span><br><span class="line">│   │   └── valid.list					分类器所有验证样本的路径</span><br><span class="line">│   ├── new_img							分类器样本标记后存储在该文件夹</span><br><span class="line">│   ├── old_img							分类器样本标记前存储在该文件夹</span><br><span class="line">│   └── label_hanzi.py					标记分类器样本的脚本</span><br><span class="line">├── darknet								darknet二进制文件</span><br><span class="line">├── examples</span><br><span class="line">├── getmap.py							计算定位器的mAP</span><br><span class="line">├── include</span><br><span class="line">├── jiyan</span><br><span class="line">│   ├── backup							定位器权重存储文件	</span><br><span class="line">│   ├── data</span><br><span class="line">│   │   ├── train						定位器训练集</span><br><span class="line">│   │   ├── valid						定位器验证集</span><br><span class="line">│   │   ├── train.txt					定位器所有训练样本的路径</span><br><span class="line">│   │   ├── valid.txt					定位器所有验证样本的路径</span><br><span class="line">│   │   └── yolo.names					定位器标签仅一个，hanzi</span><br><span class="line">│   ├── get_pic.py						爬取gsxt网站验证码的脚本</span><br><span class="line">│   └── raw_img							最初爬取的2W张极验验证码图片（汉字识别已用过）</span><br><span class="line">├── python</span><br><span class="line">│   ├── hanzi_img                       破解验证码时，存储的切割汉字图片的文件夹</span><br><span class="line">│   ├── valid							测试集-500张（测试破解接口的准确率）</span><br><span class="line">│   ├── valid.txt						测试集标记文件</span><br><span class="line">│   ├── crack_pro.py					具有一定汉字纠错能力的验证码破解接口</span><br><span class="line">│   ├── darknet.py						定位器和分类器调用接口</span><br><span class="line">│   ├── recog_order.py					识别语序接口</span><br><span class="line">│   ├── segment.py 						切割汉字接口</span><br><span class="line">│   └── dict.txt						识别语序时用到的带词频的字典</span><br><span class="line">├── results								生成的anchor.txt会存在此文件</span><br><span class="line">├── scripts</span><br><span class="line">├── src									darknet源代码</span><br><span class="line">└── tools</span><br><span class="line">	├── voc_label.py					.xml标签转换为.txt标签</span><br><span class="line">	├── generate_anchorsv2.py			YOLOV2生成anchors脚本</span><br><span class="line">	└── generate_anchorsv3.py			YOLOV3生成anchors脚本</span><br></pre></td></tr></table></figure></p>
<h3 id="Makefile文件配置"><a href="#Makefile文件配置" class="headerlink" title="Makefile文件配置"></a>Makefile文件配置</h3><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line">GPU=1         					# 置1，使用GPU训练</span><br><span class="line">CUDNN=0							</span><br><span class="line">OPENCV=1						# 置1，开启opencv</span><br><span class="line">OPENMP=0</span><br><span class="line">DEBUG=0</span><br><span class="line"></span><br><span class="line"># 若make时，下面这行出现问题，可强制执行此行</span><br><span class="line">ARCH= -D_FORCE_INLINES -gencode arch=compute_30,code=sm_30 \</span><br><span class="line">      -gencode arch=compute_35,code=sm_35 \</span><br><span class="line">      -gencode arch=compute_50,code=[sm_50,compute_50] \</span><br><span class="line">      -gencode arch=compute_52,code=[sm_52,compute_52]</span><br><span class="line">#      -gencode arch=compute_20,code=[sm_20,sm_21] \ This one is deprecated?</span><br><span class="line"></span><br><span class="line"># This is what I use, uncomment if you know your arch and want to specify</span><br><span class="line"># ARCH= -gencode arch=compute_52,code=compute_52</span><br><span class="line"></span><br><span class="line">VPATH=./src/:./examples</span><br><span class="line">SLIB=libdarknet.so</span><br><span class="line">ALIB=libdarknet.a</span><br><span class="line">EXEC=darknet</span><br><span class="line">OBJDIR=./obj/</span><br><span class="line">......</span><br><span class="line">......</span><br></pre></td></tr></table></figure>
<blockquote>
<p><strong>提示</strong>：修改Makefile或源码后，需在命令行先敲击<code>make clean</code>命令，再敲击<code>make</code>命令，方能生效。</p>
</blockquote>
<h2 id="定位器训练"><a href="#定位器训练" class="headerlink" title="定位器训练"></a>定位器训练</h2><h3 id="训练数据准备"><a href="#训练数据准备" class="headerlink" title="训练数据准备"></a>训练数据准备</h3><h4 id="样本的获取"><a href="#样本的获取" class="headerlink" title="样本的获取"></a>样本的获取</h4><p>训练定位器样本的获取方法：爬取<a href="http://www.gsxt.gov.cn/index.html" target="_blank" rel="noopener">国家企业信用信息公示系统</a>，使用脚本<code>jiyan/get_pic.py</code>进行爬取即可。</p>
<h4 id="样本的标注"><a href="#样本的标注" class="headerlink" title="样本的标注"></a>样本的标注</h4><p>使用标注软件<strong>labelimg</strong>对样本图片进行标注。有关<strong>labelimg</strong>软件的安装与使用请自行百度，这里不再赘述。</p>
<p>通过labelimg将图片标注后，会生成该图片对应的<strong>.xml标签</strong>，训练数据时需要的是<strong>.txt标签</strong>，我们需要将<strong>.xml标签</strong>转化为<strong>.txt标签</strong>。转换脚本见<code>tools/voc_label.py</code>。</p>
<h4 id="文件准备"><a href="#文件准备" class="headerlink" title="文件准备"></a>文件准备</h4><ol>
<li>定位器网络配置文件<code>cfg/yolo-origin.cfg</code></li>
</ol>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br></pre></td><td class="code"><pre><span class="line">[net]</span><br><span class="line"><span class="comment"># Training</span></span><br><span class="line">batch=64						<span class="comment"># 每batch个样本更新一次参数</span></span><br><span class="line">subdivisions=16					<span class="comment"># 如果内存不够大将batch分割为subdivisions个子batch，每个									# 子batch的大小为batch/subdivisions</span></span><br><span class="line">height=416						<span class="comment"># input图像的高</span></span><br><span class="line">width=416						<span class="comment"># input图像的宽</span></span><br><span class="line">channels=3						<span class="comment"># input图像的通道数</span></span><br><span class="line">momentum=0.9					<span class="comment"># 梯度下降法中一种加速技术，建议配置0.9</span></span><br><span class="line">decay=0.0005					<span class="comment"># 衰减权重正则项，防止过拟合</span></span><br><span class="line">angle=0							<span class="comment"># 通过旋转角度来生成更多训练样本</span></span><br><span class="line">saturation = 1.5				<span class="comment"># 通过调整饱和度来生成更多训练样本</span></span><br><span class="line">exposure = 1.5					<span class="comment"># 通过调整曝光度来生成更多训练样本</span></span><br><span class="line">hue=.1							<span class="comment"># 通过调整色调来生成更多训练样本</span></span><br><span class="line"></span><br><span class="line">learning_rate=0.001				<span class="comment"># 学习率</span></span><br><span class="line">burn_in=1000					 </span><br><span class="line">max_batches = 80200				<span class="comment"># 训练达到max_batches后停止学习</span></span><br><span class="line">policy=steps					<span class="comment"># 调整学习率的policy</span></span><br><span class="line">steps=40000,60000				<span class="comment"># 根据batch_bum调整学习率</span></span><br><span class="line">scales=.1,.1					<span class="comment"># 学习率的变化比例，累计相乘:迭代达到40000，学习率衰减十倍</span></span><br><span class="line">								<span class="comment"># 60000迭代时，学习率又会在前一个学习率的基础上衰减十倍				</span></span><br><span class="line">[convolutional]					</span><br><span class="line">batch_normalize=1</span><br><span class="line">filters=32</span><br><span class="line">size=3</span><br><span class="line">stride=1</span><br><span class="line">pad=1</span><br><span class="line">activation=leaky</span><br><span class="line">......</span><br><span class="line">......</span><br><span class="line">[convolutional]</span><br><span class="line">size=1</span><br><span class="line">stride=1</span><br><span class="line">pad=1</span><br><span class="line">filters=30						<span class="comment"># region前最后一个卷积层的filters数是特定的，本项目为30</span></span><br><span class="line">activation=linear</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">[region]</span><br><span class="line">anchors = 2.1882101346810248, 1.7273508247089326, 2.5877106474986844, 2.3101804619114943, 1.8459417510394331, 1.7319281925870702, 2.125632169606032, 2.0649405635139693, 2.458238797504399, 1.9738465447154578</span><br><span class="line">								<span class="comment"># 预选框，可以通过generate_anchorsv2.py文件生成</span></span><br><span class="line">bias_match=1</span><br><span class="line">classes=1						<span class="comment"># 网络需要识别的物体种类数，本项目为1即：hanzi</span></span><br><span class="line">coords=4						<span class="comment"># 每个box的4个坐标：tx,ty,tw,th</span></span><br><span class="line">num=5							<span class="comment"># 每个网格单元预测几个box，和anchors的数量一致</span></span><br><span class="line">softmax=1						<span class="comment"># 使用softmax做激活函数</span></span><br><span class="line">jitter=.3						<span class="comment"># 通过抖动增加噪声来抑制过拟合</span></span><br><span class="line">rescore=1</span><br><span class="line"></span><br><span class="line">object_scale=5					</span><br><span class="line">noobject_scale=1</span><br><span class="line">class_scale=1</span><br><span class="line">coord_scale=1</span><br><span class="line"></span><br><span class="line">absolute=1</span><br><span class="line">thresh=.6</span><br><span class="line">random=1						<span class="comment"># random为１时，会启用Multi-Scale Training，随机使用不同								  # 尺寸的图片进行训练。</span></span><br></pre></td></tr></table></figure>
<p><strong>重要参数讲解：</strong> </p>
<ul>
<li><p><code>filter</code>应为30，其计算公式为：</p>
<script type="math/tex; mode=display">filter = num\cdot (classes + coord + 1)</script><script type="math/tex; mode=display">30 = 5\cdot (1 + 4 + 1)</script></li>
<li><p><code>num</code>代表每个网格单元预测几个box。</p>
</li>
<li><p><code>classes</code>代表一共有多少个类，本项目为1。</p>
</li>
<li><p><code>coord</code>代表回归的四个位置，分别为<code>&lt;x&gt;&lt;y&gt;&lt;width&gt;&lt;height&gt;</code>代表物体中心点相对位置以及物体相对大小。如<code>不</code>的标签为<code>0 0.20 0.76 0.16 0.16</code> ， <code>忘</code>的标签为<code>0 0.75 0.25 0.15 0.17</code>，<code>初</code>的标签为<code>0 0.25 0.20 0.17 0.17</code>，<code>心</code>的标签为<code>0 0.60 0.62 0.16 0.18</code></p>
<p><img src="/2018/11/19/破解含语序问题的点击验证码/不忘初心.png" alt="验证码"></p>
<p>这张图的标签为：</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">0 0.25 0.20 0.17 0.17</span><br><span class="line">0 0.75 0.25 0.15 0.17</span><br><span class="line">0 0.60 0.62 0.16 0.18</span><br><span class="line">0 0.20 0.76 0.16 0.16</span><br></pre></td></tr></table></figure>
</li>
</ul>
<ol>
<li>定位器训练配置文件<code>cfg/yolo-origin.data</code></li>
</ol>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">classes= 1												<span class="comment"># 类的个数，本项目为1</span></span><br><span class="line">train = jiyan/data/train.txt							<span class="comment"># 存放train.txt文件的路径</span></span><br><span class="line">valid = jiyan/data/valid.txt							<span class="comment"># 存放valid.txt文件的路径</span></span><br><span class="line">names = /home/geng/gsxt_captcha/jiyan/data/yolo.names	<span class="comment"># 存放类名字的路径</span></span><br><span class="line">backup = jiyan/backup									<span class="comment"># 训练后权重保存位置</span></span><br></pre></td></tr></table></figure>
<p><strong>重要参数讲解：</strong></p>
<ul>
<li><p><code>train</code>：该参数为存放<code>train.txt</code>文件的路径，<code>train.txt</code>文件格式如下：</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">......</span><br><span class="line">......</span><br><span class="line">/home/geng/darknet/jiyan/data/train/1530946690.jpg</span><br><span class="line">/home/geng/darknet/jiyan/data/train/3062060956.jpg</span><br><span class="line">/home/geng/darknet/jiyan/data/train/3062062538.jpg</span><br><span class="line">......</span><br><span class="line">......</span><br></pre></td></tr></table></figure>
<p>即<code>train.txt</code>文件保存了所有训练样本的路径。在上述路径中的train文件内必须同时存放样本及其对应的标签，即：</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">......</span><br><span class="line">......</span><br><span class="line">1528780328740.jpg  1530947539.jpg     3062055104.jpg  3062097132.jpg</span><br><span class="line">1528780328740.txt  1530947539.txt     3062055104.txt  3062097132.txt</span><br><span class="line">1528780333363.jpg  1530947544.jpg     3062055126.jpg  3062097142.jpg</span><br><span class="line">1528780333363.txt  1530947544.txt     3062055126.txt  3062097142.txt</span><br><span class="line">......</span><br><span class="line">......</span><br></pre></td></tr></table></figure>
<p><strong>生成train.txt：</strong>通过以下命令行命令来生成路径文件<code>train.txt</code>：</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">find `<span class="built_in">pwd</span>`/train -name \*.jpg &gt; train.txt</span><br></pre></td></tr></table></figure>
</li>
<li><p><code>valid</code>：该参数为存放<code>valid.txt</code>文件的路径，<code>valid.txt</code>文件格式如下：</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">......</span><br><span class="line">......</span><br><span class="line">/home/geng/darknet/jiyan/data/valid/1530953866.jpg</span><br><span class="line">/home/geng/darknet/jiyan/data/valid/1530954184.jpg</span><br><span class="line">/home/geng/darknet/jiyan/data/valid/1530952279.jpg</span><br><span class="line">......</span><br><span class="line">......</span><br></pre></td></tr></table></figure>
<p>即<code>valid.txt</code>文件保存了所有验证样本的路径。<strong>需要注意的是：</strong>上述路径中的valid文件内必须同时存放样本及其对应的<code>.txt</code>标签和<code>.xml</code>标签，即：</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">1530952510.jpg  1530953474.jpg  1530955039.jpg  3062099066.jpg  3062107032.jpg</span><br><span class="line">1530952510.txt  1530953474.txt  1530955039.txt  3062099066.txt  3062107032.txt</span><br><span class="line">1530952510.xml  1530953474.xml  1530955039.xml  3062099066.xml  3062107032.xml</span><br><span class="line">1530952529.jpg  1530953479.jpg  1530955044.jpg  3062099078.jpg  3062107044.jpg</span><br><span class="line">1530952529.txt  1530953479.txt  1530955044.txt  3062099078.txt  3062107044.txt</span><br><span class="line">1530952529.xml  1530953479.xml  1530955044.xml  3062099078.xml  3062107044.xml</span><br></pre></td></tr></table></figure>
<p><strong>生成valid.txt：</strong>通过以下命令行命令来生成路径文件<code>valid.txt</code>：</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">find `<span class="built_in">pwd</span>`/valid -name \*.jpg &gt; valid.txt</span><br></pre></td></tr></table></figure>
</li>
</ul>
<h3 id="模型训练"><a href="#模型训练" class="headerlink" title="模型训练"></a>模型训练</h3><p>配置文件和数据集准备好之后，我们就可以开始训练了,训练命令如下:</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">./darknet detector train cfg/yolo-origin.data cfg/yolo-origin.cfg</span><br></pre></td></tr></table></figure>
<p>若在原有权重的基础上进行训练，使用如下命令：</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">./darknet detector train cfg/yolo-origin.data cfg/yolo-origin.cfg jiyan/backup/yolo-origin.backup</span><br></pre></td></tr></table></figure>
<h3 id="训练结果评估"><a href="#训练结果评估" class="headerlink" title="训练结果评估"></a>训练结果评估</h3><p>目标检测中衡量识别精度的指标是mAP（mean average precision），mAP越接近1，表示定位效果越好。在计算mAP时，需要先根据训练的模型生成检测结果，然后使用<code>getmap.py</code>脚本计算mAP。</p>
<p><strong>生成检测结果：</strong></p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">./darknet detector valid cfg/yolo-origin.data cfg/yolo-origin.cfg jiyan/backup/yolo-origin.backup</span><br></pre></td></tr></table></figure>
<p>生成的检测结果会存放在<code>results/comp4_det_test_hanzi.txt</code>文件内。</p>
<p><strong>计算mAP：</strong></p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">python getmap.py results/comp4_det_test_hanzi.txt jiyan/data/valid.txt hanzi</span><br></pre></td></tr></table></figure>
<h2 id="分类器训练"><a href="#分类器训练" class="headerlink" title="分类器训练"></a>分类器训练</h2><h3 id="训练数据准备-1"><a href="#训练数据准备-1" class="headerlink" title="训练数据准备"></a>训练数据准备</h3><h4 id="样本的获取-1"><a href="#样本的获取-1" class="headerlink" title="样本的获取"></a>样本的获取</h4><p>分类器样本的获取方法是通过对定位的汉字进行切割获取的。汉字切割脚本见<code>python/segment.py</code>。</p>
<h4 id="样本的标注-1"><a href="#样本的标注-1" class="headerlink" title="样本的标注"></a>样本的标注</h4><p>分类器样本的标注，即对切割的汉字图片进行标记。<strong>实质上是修改汉字图片的文件名</strong>，所涉及的原理在下面的文件准备中有讲解。标注过程解释如下：</p>
<div class="table-container">
<table>
<thead>
<tr>
<th style="text-align:center">汉字</th>
<th style="text-align:center">汉字对应的Unicode</th>
<th style="text-align:center">切割得到的汉字图片文件名</th>
<th style="text-align:center">标记后的汉字图片文件名</th>
</tr>
</thead>
<tbody>
<tr>
<td style="text-align:center">健</td>
<td style="text-align:center">\u5065</td>
<td style="text-align:center">15310991303473_label.jpg</td>
<td style="text-align:center">15310991303473_u5065.jpg</td>
</tr>
<tr>
<td style="text-align:center">声</td>
<td style="text-align:center">\u58f0</td>
<td style="text-align:center">15310991261628_label.jpg</td>
<td style="text-align:center">15310991261628_u58f0.jpg</td>
</tr>
</tbody>
</table>
</div>
<p>汉字识别的标注脚本已经写好，见<code>label_hanzi.py</code>。</p>
<h4 id="文件准备-1"><a href="#文件准备-1" class="headerlink" title="文件准备"></a>文件准备</h4><ol>
<li>分类器网络配置文件<code>cfg/chinese_character.cfg</code></li>
</ol>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br></pre></td><td class="code"><pre><span class="line">[net]</span><br><span class="line">batch=64</span><br><span class="line">subdivisions=1</span><br><span class="line">height=64</span><br><span class="line">width=64</span><br><span class="line">channels=3</span><br><span class="line">max_crop=64</span><br><span class="line">min_crop=64</span><br><span class="line">angle=7</span><br><span class="line">hue=.1</span><br><span class="line">saturation=.75</span><br><span class="line">exposure=.75</span><br><span class="line"></span><br><span class="line">learning_rate=0.1</span><br><span class="line">policy=poly</span><br><span class="line">power=4</span><br><span class="line">max_batches = 45000</span><br><span class="line">momentum=0.9</span><br><span class="line">decay=0.0005</span><br><span class="line"></span><br><span class="line">[convolutional]</span><br><span class="line">batch_normalize=1</span><br><span class="line">filters=128</span><br><span class="line">size=3</span><br><span class="line">stride=1</span><br><span class="line">pad=1</span><br><span class="line">activation=leaky</span><br><span class="line"></span><br><span class="line">......</span><br><span class="line">......</span><br><span class="line"></span><br><span class="line">[convolutional]</span><br><span class="line">filters=3604       			<span class="comment"># 此处需要与chinese_classify/data/labels.txt内的标签个数一致</span></span><br><span class="line">size=1</span><br><span class="line">stride=1</span><br><span class="line">pad=1</span><br><span class="line">activation=leaky</span><br><span class="line"></span><br><span class="line">[avgpool]</span><br><span class="line"></span><br><span class="line">[softmax]</span><br><span class="line">groups=1</span><br><span class="line"></span><br><span class="line">[cost]</span><br><span class="line"><span class="built_in">type</span>=sse</span><br></pre></td></tr></table></figure>
<p><strong>重要参数讲解：</strong></p>
<ul>
<li>最后一个convolutional层的<code>filters</code>：此处filters的值为3604，但是需要注意的是：此值应该与<code>chinese_classify/data/labels.txt</code>内的类标签个数一致。</li>
</ul>
<ol>
<li>分类器训练配置文件<code>cfg/chinese.data</code></li>
</ol>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">classes=3604         						<span class="comment"># 类的个数，此处即汉字的个数</span></span><br><span class="line">train  = chinese_classify/data/train.list    <span class="comment"># 存放train.list文件的路径</span></span><br><span class="line">valid  = chinese_classify/data/valid.list 	<span class="comment"># 存放valid.list文件的路径</span></span><br><span class="line">labels = chinese_classify/data/labels.txt 	<span class="comment"># 存放labels.txt的路径</span></span><br><span class="line">backup = chinese_classify/backup				<span class="comment"># 训练时权重的保存位置</span></span><br><span class="line">top=100</span><br></pre></td></tr></table></figure>
<p><strong>重要参数讲解：</strong></p>
<ul>
<li><p><code>classes</code>代表分类个数</p>
</li>
<li><p><code>train</code>该参数为存放<code>train.list</code>文件的路径，<code>train.list</code>文件内格式如下：</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">......</span><br><span class="line">......</span><br><span class="line">/home/geng/darknet/chinese_classify/data/train/15310999153792_u5347.jpg</span><br><span class="line">/home/geng/darknet/chinese_classify/data/train/15310991401861_u4e58.jpg</span><br><span class="line">/home/geng/darknet/chinese_classify/data/train/15310993054970_u4e4b.jpg</span><br><span class="line">......</span><br><span class="line">......</span><br></pre></td></tr></table></figure>
<p>即<code>train.txt</code>文件保存了所有训练样本的路径。在上述路径中的train文件内需要存放训练样本，即：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">......</span><br><span class="line">......</span><br><span class="line">15310993303114_u5b9d.jpg  15310996251829_u5174.jpg  15310999168611_u6765.jpg</span><br><span class="line">15310993303400_u90e8.jpg  15310996252114_u4efb.jpg  15310999168899_u5145.jpg</span><br><span class="line">15310993303403_u5185.jpg  15310996252119_u4f55.jpg  15310999168901_u7535.jpg</span><br><span class="line">......</span><br><span class="line">......</span><br></pre></td></tr></table></figure>
</li>
<li><p><code>valid</code>该参数的格式与<code>train</code>一样，不再赘述。只是该参数涉及的是验证集。</p>
</li>
<li><p><code>labels</code>为存放类标签文件<code>labels.txt</code>的路径，<code>labels.txt</code>文件内格式如下：</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">......</span><br><span class="line">......</span><br><span class="line">u6bd3</span><br><span class="line">u5347</span><br><span class="line">u90f8</span><br><span class="line">u5d58</span><br><span class="line">u8426</span><br><span class="line">......</span><br><span class="line">......</span><br></pre></td></tr></table></figure>
<p>darknet是通过文件名与<code>labels.txt</code>中的字符串做匹配，匹配到则认为该标签为匹配到的字符串。如<code>/home/geng/darknet/chinese_classify/data/train/15310999153792_u5347.jpg</code>，由于<code>labels.txt</code>中出现<code>u5347</code>，所以这张图的标签为<code>u5347</code>。所以图片的路径绝对不可以出现多个<code>labels.txt</code>中包含的字符串，如果路径为<code>somepath1/data2/3.jpg</code>，<code>labels.txt</code>包含1,2,3，则<strong>这张图片会被认为匹配1,2,3多个label从而报错</strong>。</p>
</li>
<li><p><code>top</code>代表valid时取前多少计算正确率。如<code>top100</code>代表分类时概率最大的前100类中出现了正确的标签就认为正确。</p>
</li>
</ul>
<h3 id="模型训练-1"><a href="#模型训练-1" class="headerlink" title="模型训练"></a>模型训练</h3><p>配置文件和数据集准备好之后，我们就可以开始训练了,训练命令如下:</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">./darknet classifier train cfg/chinese.data cfg/chinese_character.cfg</span><br></pre></td></tr></table></figure>
<p>若在原有权重的基础上进行训练，使用如下命令：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">./darknet classifier train cfg/chinese.data cfg/chinese_character.cfg chinese_classify/backup/chinese_character.backup</span><br></pre></td></tr></table></figure>
<p><strong>需要注意的是：</strong>如果增加样本后<code>label.txt</code>文件内增加了新的汉字标签，就不能在原有权重的基础上进行训练了，需要重新训练。    </p>
<h3 id="训练结果评估-1"><a href="#训练结果评估-1" class="headerlink" title="训练结果评估"></a>训练结果评估</h3><p>分类器模型验证比较简单，直接用准确率来评估，即：验证集中<strong>分类正确的个数/分类错误的个数</strong>。分类器模型验证命令如下：</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">./darknet classifier valid cfg/chinese.data cfg/chinese_character.cfg chinese_classify/backup/chinese_character.backup</span><br></pre></td></tr></table></figure>
<h1 id="参考文献"><a href="#参考文献" class="headerlink" title="参考文献"></a>参考文献</h1><p><a href="https://pjreddie.com/darknet/" target="_blank" rel="noopener">Darknet官方网站</a></p>
<p>You Only Look Once: Unified ,Real-Time Object Detection</p>
<p><a href="https://cos120.github.io/crack/" target="_blank" rel="noopener">https://cos120.github.io/crack/</a></p>
<h1 id="免责声明"><a href="#免责声明" class="headerlink" title="免责声明"></a>免责声明</h1><p><strong>该项目仅用于学术交流，不得任何商业使用！</strong></p>

      
    </div>

    

    
    
    
      <div>
	
	<div>
    
        <div style="text-align:center;color: #ccc;font-size:14px;">-------------本文结束<i class="fa fa-paw"></i>感谢您的阅读-------------</div>
    
</div>



	
      </div>
	
    

    

    

    <footer class="post-footer">
      
        <div class="post-tags">
          
            <a href="/tags/yolo/" rel="tag"># yolo</a>
          
            <a href="/tags/点击验证码/" rel="tag"># 点击验证码</a>
          
            <a href="/tags/国家企业信用信息公示系统/" rel="tag"># 国家企业信用信息公示系统</a>
          
        </div>
      

      
      
      

      
        <div class="post-nav">
          <div class="post-nav-next post-nav-item">
            
              <a href="/2018/11/16/体验活动的生命周期/" rel="next" title="体验活动的生命周期">
                <i class="fa fa-chevron-left"></i> 体验活动的生命周期
              </a>
            
          </div>

          <span class="post-nav-divider"></span>

          <div class="post-nav-prev post-nav-item">
            
              <a href="/2018/12/05/成功解决在hexo中无法显示数学公式的问题/" rel="prev" title="成功解决在hexo中无法显示数学公式的问题">
                成功解决在hexo中无法显示数学公式的问题 <i class="fa fa-chevron-right"></i>
              </a>
            
          </div>
        </div>
      

      
      
    </footer>
  </div>
  
  
  
  </article>



    <div class="post-spread">
      
    </div>
  </div>


          </div>
          

  
    <div class="comments" id="comments">
    </div>
  



        </div>
        
          
  
  <div class="sidebar-toggle">
    <div class="sidebar-toggle-line-wrap">
      <span class="sidebar-toggle-line sidebar-toggle-line-first"></span>
      <span class="sidebar-toggle-line sidebar-toggle-line-middle"></span>
      <span class="sidebar-toggle-line sidebar-toggle-line-last"></span>
    </div>
  </div>

  <aside id="sidebar" class="sidebar">
    
    <div class="sidebar-inner">

      

      
        <ul class="sidebar-nav motion-element">
          <li class="sidebar-nav-toc sidebar-nav-active" data-target="post-toc-wrap">
            文章目录
          </li>
          <li class="sidebar-nav-overview" data-target="site-overview-wrap">
            站点概览
          </li>
        </ul>
      

      <section class="site-overview-wrap sidebar-panel">
        <div class="site-overview">
          <div class="site-author motion-element" itemprop="author" itemscope itemtype="http://schema.org/Person">
            
              <img class="site-author-image" itemprop="image"
                src="/images/header.jpeg"
                alt="耿泽浩" />
            
              <p class="site-author-name" itemprop="name">耿泽浩</p>
              <p class="site-description motion-element" itemprop="description">Stay hungry, Stay foolish.</p>
          </div>

          
            <nav class="site-state motion-element">
              
                <div class="site-state-item site-state-posts">
                
                  <a href="/archives/">
                
                    <span class="site-state-item-count">7</span>
                    <span class="site-state-item-name">日志</span>
                  </a>
                </div>
              

              
                
                
                <div class="site-state-item site-state-categories">
                  <a href="/categories/index.html">
                    
                    
                      
                    
                      
                    
                      
                    
                      
                    
                    <span class="site-state-item-count">4</span>
                    <span class="site-state-item-name">分类</span>
                  </a>
                </div>
              

              
                
                
                <div class="site-state-item site-state-tags">
                  <a href="/tags/index.html">
                    
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                    <span class="site-state-item-count">12</span>
                    <span class="site-state-item-name">标签</span>
                  </a>
                </div>
              
            </nav>
          

          

          
            <div class="links-of-author motion-element">
              
                <span class="links-of-author-item">
                  <a href="https://github.com/runninggump" target="_blank" title="GitHub"><i class="fa fa-fw fa-github"></i>GitHub</a>
                  
                </span>
              
                <span class="links-of-author-item">
                  <a href="mailto:gengzehao@pku.edu.cn" target="_blank" title="E-Mail"><i class="fa fa-fw fa-envelope"></i>E-Mail</a>
                  
                </span>
              
            </div>
          

          
          

          
          

          
            
          
          

        </div>
      </section>

      
      <!--noindex-->
        <section class="post-toc-wrap motion-element sidebar-panel sidebar-panel-active">
          <div class="post-toc">

            
              
            

            
              <div class="post-toc-content"><ol class="nav"><li class="nav-item nav-level-1"><a class="nav-link" href="#设计思路"><span class="nav-number">1.</span> <span class="nav-text">设计思路</span></a><ol class="nav-child"><li class="nav-item nav-level-2"><a class="nav-link" href="#前言"><span class="nav-number">1.1.</span> <span class="nav-text">前言</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#汉字定位与汉字识别"><span class="nav-number">1.2.</span> <span class="nav-text">汉字定位与汉字识别</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#汉字切割算法"><span class="nav-number">1.3.</span> <span class="nav-text">汉字切割算法</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#语序识别算法"><span class="nav-number">1.4.</span> <span class="nav-text">语序识别算法</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#使用结巴分词识别语序"><span class="nav-number">1.4.1.</span> <span class="nav-text">使用结巴分词识别语序</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#使用搜索引擎识别语序"><span class="nav-number">1.4.2.</span> <span class="nav-text">使用搜索引擎识别语序</span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#完整破解程序"><span class="nav-number">1.5.</span> <span class="nav-text">完整破解程序</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#程序讲解"><span class="nav-number">1.5.1.</span> <span class="nav-text">程序讲解</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#测试正确率"><span class="nav-number">1.5.2.</span> <span class="nav-text">测试正确率</span></a></li></ol></li></ol></li><li class="nav-item nav-level-1"><a class="nav-link" href="#模型训练文档"><span class="nav-number">2.</span> <span class="nav-text">模型训练文档</span></a><ol class="nav-child"><li class="nav-item nav-level-2"><a class="nav-link" href="#依赖"><span class="nav-number">2.1.</span> <span class="nav-text">依赖</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#文件结构"><span class="nav-number">2.2.</span> <span class="nav-text">文件结构</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#Makefile文件配置"><span class="nav-number">2.2.1.</span> <span class="nav-text">Makefile文件配置</span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#定位器训练"><span class="nav-number">2.3.</span> <span class="nav-text">定位器训练</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#训练数据准备"><span class="nav-number">2.3.1.</span> <span class="nav-text">训练数据准备</span></a><ol class="nav-child"><li class="nav-item nav-level-4"><a class="nav-link" href="#样本的获取"><span class="nav-number">2.3.1.1.</span> <span class="nav-text">样本的获取</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#样本的标注"><span class="nav-number">2.3.1.2.</span> <span class="nav-text">样本的标注</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#文件准备"><span class="nav-number">2.3.1.3.</span> <span class="nav-text">文件准备</span></a></li></ol></li><li class="nav-item nav-level-3"><a class="nav-link" href="#模型训练"><span class="nav-number">2.3.2.</span> <span class="nav-text">模型训练</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#训练结果评估"><span class="nav-number">2.3.3.</span> <span class="nav-text">训练结果评估</span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#分类器训练"><span class="nav-number">2.4.</span> <span class="nav-text">分类器训练</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#训练数据准备-1"><span class="nav-number">2.4.1.</span> <span class="nav-text">训练数据准备</span></a><ol class="nav-child"><li class="nav-item nav-level-4"><a class="nav-link" href="#样本的获取-1"><span class="nav-number">2.4.1.1.</span> <span class="nav-text">样本的获取</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#样本的标注-1"><span class="nav-number">2.4.1.2.</span> <span class="nav-text">样本的标注</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#文件准备-1"><span class="nav-number">2.4.1.3.</span> <span class="nav-text">文件准备</span></a></li></ol></li><li class="nav-item nav-level-3"><a class="nav-link" href="#模型训练-1"><span class="nav-number">2.4.2.</span> <span class="nav-text">模型训练</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#训练结果评估-1"><span class="nav-number">2.4.3.</span> <span class="nav-text">训练结果评估</span></a></li></ol></li></ol></li><li class="nav-item nav-level-1"><a class="nav-link" href="#参考文献"><span class="nav-number">3.</span> <span class="nav-text">参考文献</span></a></li><li class="nav-item nav-level-1"><a class="nav-link" href="#免责声明"><span class="nav-number">4.</span> <span class="nav-text">免责声明</span></a></li></ol></div>
            

          </div>
        </section>
      <!--/noindex-->
      

      

    </div>
  </aside>


        
      </div>
    </main>

    <footer id="footer" class="footer">
      <div class="footer-inner">
        <div class="copyright">&copy; <span itemprop="copyrightYear">2019</span>
  <span class="with-love" id="animate">
    <i class="fa fa-user"></i>
  </span>
  <span class="author" itemprop="copyrightHolder">耿泽浩</span>

  

  
</div>




  <div class="powered-by">由 <a class="theme-link" target="_blank" href="https://hexo.io">Hexo</a> 强力驱动 v3.7.1</div>



  <span class="post-meta-divider">|</span>



  <div class="theme-info">主题 &mdash; <a class="theme-link" target="_blank" href="https://theme-next.org">NexT.Muse</a> v6.3.0</div>




        
<div class="busuanzi-count">
  <script async src="https://dn-lbstatics.qbox.me/busuanzi/2.3/busuanzi.pure.mini.js"></script>

  
    <span class="site-uv" title="总访客量">
      <i class="fa fa-user"></i>
      <span class="busuanzi-value" id="busuanzi_value_site_uv"></span>
    </span>
  

  
    <span class="site-pv" title="总访问量">
      <i class="fa fa-eye"></i>
      <span class="busuanzi-value" id="busuanzi_value_site_pv"></span>
    </span>
  
</div>









        
      </div>
    </footer>

    
      <div class="back-to-top">
        <i class="fa fa-arrow-up"></i>
        
      </div>
    

    

  </div>

  

<script type="text/javascript">
  if (Object.prototype.toString.call(window.Promise) !== '[object Function]') {
    window.Promise = null;
  }
</script>














  













  
  
    <script type="text/javascript" src="/lib/jquery/index.js?v=2.1.3"></script>
  

  
  
    <script type="text/javascript" src="/lib/velocity/velocity.min.js?v=1.2.1"></script>
  

  
  
    <script type="text/javascript" src="/lib/velocity/velocity.ui.min.js?v=1.2.1"></script>
  

  
  
    <script type="text/javascript" src="/lib/canvas-nest/canvas-nest.min.js"></script>
  


  


  <script type="text/javascript" src="/js/src/utils.js?v=6.3.0"></script>

  <script type="text/javascript" src="/js/src/motion.js?v=6.3.0"></script>



  
  

  
  <script type="text/javascript" src="/js/src/scrollspy.js?v=6.3.0"></script>
<script type="text/javascript" src="/js/src/post-details.js?v=6.3.0"></script>



  


  <script type="text/javascript" src="/js/src/bootstrap.js?v=6.3.0"></script>



  



	





  





  








  <script src="//cdn1.lncld.net/static/js/3.0.4/av-min.js"></script>
  
  
  <script src="//unpkg.com/valine/dist/Valine.min.js"></script>
  
  <script type="text/javascript">
    var GUEST = ['nick','mail','link'];
    var guest = 'nick,mail,link';
    guest = guest.split(',').filter(function (item) {
      return GUEST.indexOf(item)>-1;
    });
    new Valine({
        el: '#comments' ,
        verify: false,
        notify: false,
        appId: 'hKX77J9WvoWl9k8PpSILsgkR-gzGzoHsz',
        appKey: 'Sxbtafzp7SeXYiz16AxmRnDs',
        placeholder: 'Just go go',
        avatar:'monsterid',
        guest_info:guest,
        pageSize:'10' || 10,
    });
  </script>



  

  <script type="text/javascript">
    // Popup Window;
    var isfetched = false;
    var isXml = true;
    // Search DB path;
    var search_path = "search.xml";
    if (search_path.length === 0) {
      search_path = "search.xml";
    } else if (/json$/i.test(search_path)) {
      isXml = false;
    }
    var path = "/" + search_path;
    // monitor main search box;

    var onPopupClose = function (e) {
      $('.popup').hide();
      $('#local-search-input').val('');
      $('.search-result-list').remove();
      $('#no-result').remove();
      $(".local-search-pop-overlay").remove();
      $('body').css('overflow', '');
    }

    function proceedsearch() {
      $("body")
        .append('<div class="search-popup-overlay local-search-pop-overlay"></div>')
        .css('overflow', 'hidden');
      $('.search-popup-overlay').click(onPopupClose);
      $('.popup').toggle();
      var $localSearchInput = $('#local-search-input');
      $localSearchInput.attr("autocapitalize", "none");
      $localSearchInput.attr("autocorrect", "off");
      $localSearchInput.focus();
    }

    // search function;
    var searchFunc = function(path, search_id, content_id) {
      'use strict';

      // start loading animation
      $("body")
        .append('<div class="search-popup-overlay local-search-pop-overlay">' +
          '<div id="search-loading-icon">' +
          '<i class="fa fa-spinner fa-pulse fa-5x fa-fw"></i>' +
          '</div>' +
          '</div>')
        .css('overflow', 'hidden');
      $("#search-loading-icon").css('margin', '20% auto 0 auto').css('text-align', 'center');

      

      $.ajax({
        url: path,
        dataType: isXml ? "xml" : "json",
        async: true,
        success: function(res) {
          // get the contents from search data
          isfetched = true;
          $('.popup').detach().appendTo('.header-inner');
          var datas = isXml ? $("entry", res).map(function() {
            return {
              title: $("title", this).text(),
              content: $("content",this).text(),
              url: $("url" , this).text()
            };
          }).get() : res;
          var input = document.getElementById(search_id);
          var resultContent = document.getElementById(content_id);
          var inputEventFunction = function() {
            var searchText = input.value.trim().toLowerCase();
            var keywords = searchText.split(/[\s\-]+/);
            if (keywords.length > 1) {
              keywords.push(searchText);
            }
            var resultItems = [];
            if (searchText.length > 0) {
              // perform local searching
              datas.forEach(function(data) {
                var isMatch = false;
                var hitCount = 0;
                var searchTextCount = 0;
                var title = data.title.trim();
                var titleInLowerCase = title.toLowerCase();
                var content = data.content.trim().replace(/<[^>]+>/g,"");
                
                var contentInLowerCase = content.toLowerCase();
                var articleUrl = decodeURIComponent(data.url);
                var indexOfTitle = [];
                var indexOfContent = [];
                // only match articles with not empty titles
                if(title != '') {
                  keywords.forEach(function(keyword) {
                    function getIndexByWord(word, text, caseSensitive) {
                      var wordLen = word.length;
                      if (wordLen === 0) {
                        return [];
                      }
                      var startPosition = 0, position = [], index = [];
                      if (!caseSensitive) {
                        text = text.toLowerCase();
                        word = word.toLowerCase();
                      }
                      while ((position = text.indexOf(word, startPosition)) > -1) {
                        index.push({position: position, word: word});
                        startPosition = position + wordLen;
                      }
                      return index;
                    }

                    indexOfTitle = indexOfTitle.concat(getIndexByWord(keyword, titleInLowerCase, false));
                    indexOfContent = indexOfContent.concat(getIndexByWord(keyword, contentInLowerCase, false));
                  });
                  if (indexOfTitle.length > 0 || indexOfContent.length > 0) {
                    isMatch = true;
                    hitCount = indexOfTitle.length + indexOfContent.length;
                  }
                }

                // show search results

                if (isMatch) {
                  // sort index by position of keyword

                  [indexOfTitle, indexOfContent].forEach(function (index) {
                    index.sort(function (itemLeft, itemRight) {
                      if (itemRight.position !== itemLeft.position) {
                        return itemRight.position - itemLeft.position;
                      } else {
                        return itemLeft.word.length - itemRight.word.length;
                      }
                    });
                  });

                  // merge hits into slices

                  function mergeIntoSlice(text, start, end, index) {
                    var item = index[index.length - 1];
                    var position = item.position;
                    var word = item.word;
                    var hits = [];
                    var searchTextCountInSlice = 0;
                    while (position + word.length <= end && index.length != 0) {
                      if (word === searchText) {
                        searchTextCountInSlice++;
                      }
                      hits.push({position: position, length: word.length});
                      var wordEnd = position + word.length;

                      // move to next position of hit

                      index.pop();
                      while (index.length != 0) {
                        item = index[index.length - 1];
                        position = item.position;
                        word = item.word;
                        if (wordEnd > position) {
                          index.pop();
                        } else {
                          break;
                        }
                      }
                    }
                    searchTextCount += searchTextCountInSlice;
                    return {
                      hits: hits,
                      start: start,
                      end: end,
                      searchTextCount: searchTextCountInSlice
                    };
                  }

                  var slicesOfTitle = [];
                  if (indexOfTitle.length != 0) {
                    slicesOfTitle.push(mergeIntoSlice(title, 0, title.length, indexOfTitle));
                  }

                  var slicesOfContent = [];
                  while (indexOfContent.length != 0) {
                    var item = indexOfContent[indexOfContent.length - 1];
                    var position = item.position;
                    var word = item.word;
                    // cut out 100 characters
                    var start = position - 20;
                    var end = position + 80;
                    if(start < 0){
                      start = 0;
                    }
                    if (end < position + word.length) {
                      end = position + word.length;
                    }
                    if(end > content.length){
                      end = content.length;
                    }
                    slicesOfContent.push(mergeIntoSlice(content, start, end, indexOfContent));
                  }

                  // sort slices in content by search text's count and hits' count

                  slicesOfContent.sort(function (sliceLeft, sliceRight) {
                    if (sliceLeft.searchTextCount !== sliceRight.searchTextCount) {
                      return sliceRight.searchTextCount - sliceLeft.searchTextCount;
                    } else if (sliceLeft.hits.length !== sliceRight.hits.length) {
                      return sliceRight.hits.length - sliceLeft.hits.length;
                    } else {
                      return sliceLeft.start - sliceRight.start;
                    }
                  });

                  // select top N slices in content

                  var upperBound = parseInt('1');
                  if (upperBound >= 0) {
                    slicesOfContent = slicesOfContent.slice(0, upperBound);
                  }

                  // highlight title and content

                  function highlightKeyword(text, slice) {
                    var result = '';
                    var prevEnd = slice.start;
                    slice.hits.forEach(function (hit) {
                      result += text.substring(prevEnd, hit.position);
                      var end = hit.position + hit.length;
                      result += '<b class="search-keyword">' + text.substring(hit.position, end) + '</b>';
                      prevEnd = end;
                    });
                    result += text.substring(prevEnd, slice.end);
                    return result;
                  }

                  var resultItem = '';

                  if (slicesOfTitle.length != 0) {
                    resultItem += "<li><a href='" + articleUrl + "' class='search-result-title'>" + highlightKeyword(title, slicesOfTitle[0]) + "</a>";
                  } else {
                    resultItem += "<li><a href='" + articleUrl + "' class='search-result-title'>" + title + "</a>";
                  }

                  slicesOfContent.forEach(function (slice) {
                    resultItem += "<a href='" + articleUrl + "'>" +
                      "<p class=\"search-result\">" + highlightKeyword(content, slice) +
                      "...</p>" + "</a>";
                  });

                  resultItem += "</li>";
                  resultItems.push({
                    item: resultItem,
                    searchTextCount: searchTextCount,
                    hitCount: hitCount,
                    id: resultItems.length
                  });
                }
              })
            };
            if (keywords.length === 1 && keywords[0] === "") {
              resultContent.innerHTML = '<div id="no-result"><i class="fa fa-search fa-5x" /></div>'
            } else if (resultItems.length === 0) {
              resultContent.innerHTML = '<div id="no-result"><i class="fa fa-frown-o fa-5x" /></div>'
            } else {
              resultItems.sort(function (resultLeft, resultRight) {
                if (resultLeft.searchTextCount !== resultRight.searchTextCount) {
                  return resultRight.searchTextCount - resultLeft.searchTextCount;
                } else if (resultLeft.hitCount !== resultRight.hitCount) {
                  return resultRight.hitCount - resultLeft.hitCount;
                } else {
                  return resultRight.id - resultLeft.id;
                }
              });
              var searchResultList = '<ul class=\"search-result-list\">';
              resultItems.forEach(function (result) {
                searchResultList += result.item;
              })
              searchResultList += "</ul>";
              resultContent.innerHTML = searchResultList;
            }
          }

          if ('auto' === 'auto') {
            input.addEventListener('input', inputEventFunction);
          } else {
            $('.search-icon').click(inputEventFunction);
            input.addEventListener('keypress', function (event) {
              if (event.keyCode === 13) {
                inputEventFunction();
              }
            });
          }

          // remove loading animation
          $(".local-search-pop-overlay").remove();
          $('body').css('overflow', '');

          proceedsearch();
        }
      });
    }

    // handle and trigger popup window;
    $('.popup-trigger').click(function(e) {
      e.stopPropagation();
      if (isfetched === false) {
        searchFunc(path, 'local-search-input', 'local-search-result');
      } else {
        proceedsearch();
      };
    });

    $('.popup-btn-close').click(onPopupClose);
    $('.popup').click(function(e){
      e.stopPropagation();
    });
    $(document).on('keyup', function (event) {
      var shouldDismissSearchPopup = event.which === 27 &&
        $('.search-popup').is(':visible');
      if (shouldDismissSearchPopup) {
        onPopupClose();
      }
    });
  </script>





  

  
  <script src="https://cdn1.lncld.net/static/js/av-core-mini-0.6.4.js"></script>
  <script>AV.initialize("hKX77J9WvoWl9k8PpSILsgkR-gzGzoHsz", "Sxbtafzp7SeXYiz16AxmRnDs");</script>
  <script>
    function showTime(Counter) {
      var query = new AV.Query(Counter);
      var entries = [];
      var $visitors = $(".leancloud_visitors");

      $visitors.each(function () {
        entries.push( $(this).attr("id").trim() );
      });

      query.containedIn('url', entries);
      query.find()
        .done(function (results) {
          var COUNT_CONTAINER_REF = '.leancloud-visitors-count';

          if (results.length === 0) {
            $visitors.find(COUNT_CONTAINER_REF).text(0);
            return;
          }

          for (var i = 0; i < results.length; i++) {
            var item = results[i];
            var url = item.get('url');
            var time = item.get('time');
            var element = document.getElementById(url);

            $(element).find(COUNT_CONTAINER_REF).text(time);
          }
          for(var i = 0; i < entries.length; i++) {
            var url = entries[i];
            var element = document.getElementById(url);
            var countSpan = $(element).find(COUNT_CONTAINER_REF);
            if( countSpan.text() == '') {
              countSpan.text(0);
            }
          }
        })
        .fail(function (object, error) {
          console.log("Error: " + error.code + " " + error.message);
        });
    }

    function addCount(Counter) {
      var $visitors = $(".leancloud_visitors");
      var url = $visitors.attr('id').trim();
      var title = $visitors.attr('data-flag-title').trim();
      var query = new AV.Query(Counter);

      query.equalTo("url", url);
      query.find({
        success: function(results) {
          if (results.length > 0) {
            var counter = results[0];
            counter.fetchWhenSave(true);
            counter.increment("time");
            
            counter.save(null, {
              success: function(counter) {
                
                  var $element = $(document.getElementById(url));
                  $element.find('.leancloud-visitors-count').text(counter.get('time'));
                
              },
              error: function(counter, error) {
                console.log('Failed to save Visitor num, with error message: ' + error.message);
              }
            });
          } else {
            
              var newcounter = new Counter();
              /* Set ACL */
              var acl = new AV.ACL();
              acl.setPublicReadAccess(true);
              acl.setPublicWriteAccess(true);
              newcounter.setACL(acl);
              /* End Set ACL */
              newcounter.set("title", title);
              newcounter.set("url", url);
              newcounter.set("time", 1);
              newcounter.save(null, {
                success: function(newcounter) {
                  var $element = $(document.getElementById(url));
                  $element.find('.leancloud-visitors-count').text(newcounter.get('time'));
                },
                error: function(newcounter, error) {
                  console.log('Failed to create');
                }
              });
            
          }
        },
        error: function(error) {
          console.log('Error:' + error.code + " " + error.message);
        }
      });
    }

    $(function() {
      var Counter = AV.Object.extend("Counter");
      if ($('.leancloud_visitors').length == 1) {
        addCount(Counter);
      } else if ($('.post-title-link').length > 1) {
        showTime(Counter);
      }
    });
  </script>



  

  

  
  

  
  

  
    
      <script type="text/x-mathjax-config">
    MathJax.Hub.Config({
      tex2jax: {
        inlineMath: [ ['$','$'], ["\\(","\\)"]  ],
        processEscapes: true,
        skipTags: ['script', 'noscript', 'style', 'textarea', 'pre', 'code']
      },
      TeX: {equationNumbers: { autoNumber: "AMS" }}
    });
</script>

<script type="text/x-mathjax-config">
    MathJax.Hub.Queue(function() {
      var all = MathJax.Hub.getAllJax(), i;
        for (i=0; i < all.length; i += 1) {
          all[i].SourceElement().parentNode.className += ' has-jax';
        }
    });
</script>
<script type="text/javascript" src="//cdn.jsdelivr.net/npm/mathjax@2.7.1/MathJax.js?config=TeX-AMS-MML_HTMLorMML"></script>

    
  


  
  

  

  

  

  

  

</body>
</html>
<!-- 页面点击小红心 --> <script type="text/javascript" src="/js/src/love.js"></script>
